<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IBS 엑셀 견적서 - 자동계산 기능 (개선버전)</title>


    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
            scroll-behavior: auto;
            overflow-x: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #2c5aa0, #1e3f73);
            color: white;
            padding: 20px;
            border-radius: 10px;
        }
        .quote-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .form-section {
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #2c5aa0;
            margin-bottom: 4px;
        }
        .form-section h3 {
            font-size: 15px;
            margin: 0 0 6px 0;
            color: #2c5aa0;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 2px;
            align-items: center;
        }
        .form-group {
            flex: 1;
        }
        label {
            font-weight: bold;
            color: #2c5aa0;
            display: block;
            margin-bottom: 2px;
            font-size: 12px;
        }
        input, select, textarea {
            width: 100%;
            padding: 5px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
            font-size: 12px;
        }
        textarea {
            resize: none;
            overflow: hidden;
        }
        /* 입력 시 스크롤 방지 */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 3px rgba(44, 90, 160, 0.3);
        }
        /* 모바일에서 줌 방지 */
        input[type="text"], input[type="number"], input[type="email"], input[type="date"], select, textarea {
            font-size: 16px;
        }
        @media (max-width: 768px) {
            input[type="text"], input[type="number"], input[type="email"], input[type="date"], select, textarea {
                font-size: 16px;
            }
        }
        .quote-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0 0 0;
            background-color: white;
            table-layout: fixed;
        }
        /* 화면에서 열 너비 최적화 */
        .quote-table th:nth-child(1) { width: 8%; }   /* NO */
        .quote-table th:nth-child(2) { width: 20%; }  /* 서비스/제품명 */
        .quote-table th:nth-child(3) { width: 35%; }  /* 규격/사양 */
        .quote-table th:nth-child(4) { width: 8%; }   /* 수량 */
        .quote-table th:nth-child(5) { width: 12%; }  /* 단가 */
        .quote-table th:nth-child(6) { width: 12%; }  /* 금액 */
        .quote-table th:nth-child(7) { width: 5%; }   /* 삭제 */
        .quote-table th, .quote-table td {
            border: 1px solid #ddd;
            padding: 6px 4px;
            text-align: left;
            font-size: 12px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .quote-table th {
            background-color: #f8f9fa;
            color: #333;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
        }
        .quote-table input, .quote-table select {
            border: none;
            background: transparent;
            width: 100%;
            padding: 5px;
        }
        .quote-table input:focus, .quote-table select:focus, .quote-table textarea:focus {
            outline: none;
            border: 1px solid #2c5aa0;
            background-color: #f8f9fa;
        }
        .amount-input {
            text-align: right;
        }
        .total-section {
            background-color: #e3f2fd;
            padding: 10px 14px;
            border-radius: 6px;
            margin-top: 8px;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 14px;
        }
        .final-total {
            border-top: 2px solid #2c5aa0;
            padding-top: 6px;
            font-size: 16px;
            font-weight: bold;
            color: #2c5aa0;
        }
        .btn {
            background-color: #2c5aa0;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background-color: #1e3f73;
        }
        .btn-group {
            text-align: center;
            margin-top: 10px;
        }
        .editable {
            background-color: #fff;
            border: 1px solid #ddd;
        }
        .readonly {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        /* 약정사항 스타일 */
        .terms-section {
            margin-top: 20px;
            font-size: 11px;
            color: #666;
            background-color: #fafafa;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #2c5aa0;
        }
        .terms-section h4 {
            font-size: 13px;
            margin: 0 0 10px 0;
            color: #2c5aa0;
            font-weight: bold;
        }
        .terms-section ol {
            padding-left: 20px;
            line-height: 1.4;
            margin: 0;
        }
        .terms-section li {
            margin-bottom: 6px;
        }
        
        /* 데이터 유지 알림 */
        .data-notice {
            background-color: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            color: #2e7d32;
            margin-bottom: 10px;
            text-align: center;
        }
        
        /* 로고 대체 텍스트 */
        .logo-fallback {
            display: none;
            font-size: 16px;
            font-weight: bold;
            color: #2c5aa0;
            text-align: center;
            padding: 10px;
            border: 2px dashed #2c5aa0;
            border-radius: 6px;
        }
        
        /* 반응형 처리 */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr 1fr;
                gap: 5px;
            }
            .quote-table th, .quote-table td {
                padding: 4px 2px;
                font-size: 11px;
            }
            .btn {
                padding: 8px 16px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .container {
                margin: 10px;
                padding: 15px;
            }
        }
        
        /* 인쇄용 최적화 - A4 한 페이지 여백 최적화 */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .btn-group {
                display: none !important;
            }
            .data-notice {
                display: none !important;
            }
            /* 편집 버튼들 숨기기 */
            .quote-table button {
                display: none !important;
            }
            .quote-table .btn {
                display: none !important;
            }
            /* 삭제 열 전체 숨기기 */
            .quote-table th:last-child,
            .quote-table td:last-child {
                display: none !important;
            }
            /* 모든 편집 관련 버튼 숨기기 */
            button {
                display: none !important;
            }
            .btn {
                display: none !important;
            }
            @page {
                size: A4;
                margin: 0;
            }
            body {
                background-color: white;
                margin: 0;
                font-size: 11px;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                padding: 8mm 5mm;
                box-sizing: border-box;
            }
            .container {
                box-shadow: none;
                margin: 0;
                padding: 5px;
                transform: scale(1.0);
                transform-origin: center center;
                width: 100%;
                max-width: 210mm;
            }
            .header {
                margin-bottom: 8px !important;
                min-height: 50px !important;
                padding: 10px 15px !important;
                background: white !important;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                border-radius: 0 !important;
            }
            .header div {
                font-size: 20px !important;
                line-height: 1.2 !important;
            }
            .header span {
                font-size: 14px !important;
            }
            
            /* 회사 정보 섹션 인쇄 스타일 */
            .company-info-section {
                background-color: #f8f9fa !important;
                border-left: 3px solid #2c5aa0 !important;
                margin: 10px 0 !important;
                padding: 15px !important;
                border-radius: 4px !important;
                -webkit-print-color-adjust: exact !important;
            }
            .company-info-section h3 {
                color: #2c5aa0 !important;
                font-size: 14px !important;
                margin: 0 0 10px 0 !important;
                font-weight: bold !important;
            }
            .company-info-section h4 {
                color: #2c5aa0 !important;
                font-size: 16px !important;
                margin: 0 0 15px 0 !important;
                text-align: center !important;
                font-weight: bold !important;
            }
            .company-details p {
                font-size: 11px !important;
                margin: 3px 0 !important;
                line-height: 1.4 !important;
            }
            .company-seal div {
                border: 2px dashed #ccc !important;
                width: 55px !important;
                height: 55px !important;
            }
            .company-seal button {
                display: none !important;
            }
            .company-seal input[type="file"] {
                display: none !important;
            }
            /* 모든 파일 입력과 버튼 숨기기 */
            input[type="file"] {
                display: none !important;
            }
            /* 회사 정보 섹션의 모든 버튼 숨기기 */
            .company-info-section button {
                display: none !important;
            }
            .company-seal img {
                width: 55px !important;
                height: 55px !important;
                border-radius: 50% !important;
                object-fit: cover !important;
                display: block !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
            .form-section {
                padding: 4px 8px !important;
                margin-bottom: 4px !important;
                background-color: transparent !important;
                border-left: none !important;
            }
            .form-section h3 {
                font-size: 12px !important;
                margin: 0 0 3px 0 !important;
                color: #2c5aa0 !important;
                font-weight: bold !important;
            }
            .form-row {
                gap: 6px !important;
                margin-bottom: 4px !important;
                grid-template-columns: 1fr 1fr 1fr 1fr !important;
                align-items: baseline !important;
            }
            .form-group {
                display: block !important;
                line-height: 1.3 !important;
                min-height: 16px !important;
                white-space: nowrap !important;
            }
            label {
                font-size: 10px !important;
                margin-bottom: 0 !important;
                color: #333 !important;
                font-weight: bold !important;
                display: inline-block !important;
                width: 55px !important;
                vertical-align: baseline !important;
                margin-right: 3px !important;
                text-align: right !important;
            }
            input, select, textarea {
                padding: 1px 2px !important;
                font-size: 10px !important;
                width: calc(100% - 62px) !important;
                border: none !important;
                background: transparent !important;
                outline: none !important;
                border-bottom: 1px dotted #666 !important;
                display: inline-block !important;
                vertical-align: baseline !important;
                line-height: 1.2 !important;
                min-height: 12px !important;
            }
            .quote-table {
                margin: 5px 0 0 0 !important;
                table-layout: fixed !important;
                width: 100% !important;
            }
            /* PDF 출력 시 열 너비 최적화 */
            .quote-table th:nth-child(1) { width: 8% !important; }   /* NO */
            .quote-table th:nth-child(2) { width: 20% !important; }  /* 서비스/제품명 */
            .quote-table th:nth-child(3) { width: 42% !important; }  /* 규격/사양 */
            .quote-table th:nth-child(4) { width: 10% !important; }  /* 수량 */
            .quote-table th:nth-child(5) { width: 10% !important; }  /* 단가 */
            .quote-table th:nth-child(6) { width: 10% !important; }  /* 금액 */
            .quote-table th, .quote-table td {
                padding: 6px 4px !important;
                font-size: 10px !important;
                line-height: 1.4 !important;
                vertical-align: middle !important;
                text-align: center !important;
            }
            .quote-table th {
                font-weight: bold !important;
                background-color: #f8f9fa !important;
                border-bottom: 2px solid #ddd !important;
                color: #333 !important;
            }
            .quote-table textarea {
                padding: 4px !important;
                font-size: 9px !important;
                line-height: 1.3 !important;
                height: 50px !important;
                width: 100% !important;
                border: none !important;
                background: transparent !important;
                outline: none !important;
                resize: none !important;
                text-align: left !important;
                vertical-align: top !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }
            .quote-table select {
                font-size: 9px !important;
                width: 100% !important;
                border: none !important;
                background: transparent !important;
                outline: none !important;
                appearance: none !important;
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
            }
            .quote-table input {
                font-size: 9px !important;
                padding: 3px 4px !important;
                width: 100% !important;
                border: none !important;
                background: transparent !important;
                outline: none !important;
                text-align: center !important;
                line-height: 1.3 !important;
            }
            .quote-table input.amount-input {
                text-align: right !important;
            }
            .total-section {
                padding: 8px 12px !important;
                margin-top: 5px !important;
                background-color: transparent !important;
                border: 1px solid #ddd !important;
                border-radius: 0 !important;
            }
            .total-row {
                margin-bottom: 5px !important;
                font-size: 12px !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 2px 0 !important;
                border-bottom: 1px dotted #ddd !important;
            }
            .total-row:last-child {
                border-bottom: none !important;
            }
            .final-total {
                padding-top: 8px !important;
                font-size: 14px !important;
                border-top: 2px solid #2c5aa0 !important;
                font-weight: bold !important;
                background-color: #f8f9fa !important;
                margin-top: 5px !important;
                padding: 8px !important;
                border-bottom: none !important;
            }
            .terms-section {
                margin-top: 6px !important;
                padding: 8px !important;
                font-size: 9px !important;
                page-break-inside: avoid;
                background-color: transparent !important;
                border-left: none !important;
                border: 1px solid #ddd !important;
                border-radius: 0 !important;
            }
            .terms-section h4 {
                font-size: 11px !important;
                margin: 0 0 5px 0 !important;
            }
            .terms-section ol {
                line-height: 1.3 !important;
                padding-left: 18px !important;
                margin: 0 !important;
            }
            .terms-section li {
                margin-bottom: 3px !important;
            }
            /* 로고 이미지 크기 조정 */
            .header img {
                height: 40px !important;
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
            }
            /* 추가 여백 최적화 */
            .quote-form {
                gap: 3px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 데이터 유지 알림 -->
        <div class="data-notice" id="dataNotice" style="display: none;">
            💾 입력된 데이터가 자동으로 보존되었습니다. 새로고침해도 데이터가 유지됩니다.
        </div>
        
        <div class="header" style="display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); color: #222; padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(44,90,160,0.12); min-height: 80px; border: 1px solid rgba(44,90,160,0.1);">
            <div style="display: flex; align-items: center; gap: 20px;">
                <img src="images/logo/회사로고.jpg" alt="IBS Company Logo" style="height: 60px; width: auto; background: transparent; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 6px; transition: transform 0.2s ease;" onerror="this.style.display='none'; document.querySelector('.logo-fallback').style.display='flex';">
                <div class="logo-fallback" style="display: none; align-items: center; justify-content: center; width: 120px; height: 60px; background: linear-gradient(135deg, #2c5aa0, #1e3f73); color: white; border-radius: 6px; font-size: 14px; font-weight: bold; text-align: center; line-height: 1.2; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    IBS<br>SOLUTION
                </div>
                <div style="font-size: 26px; font-weight: bold; color: #1e3f73; line-height: 1.2; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
                    아이비에스<br><span style="font-size:14px; font-weight:normal; color:#666; letter-spacing:2px;">INNOVATION BRIDGE SOLUTION</span>
                </div>
            </div>
            <div style="font-size: 26px; font-weight: bold; color: #222; text-align: right; line-height: 1.2;">
                <span style="color: #2c5aa0; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); font-weight: 900; font-size: 32px;">I.B.S</span><br>
                <span style="font-size:18px; font-weight:normal; color:#666;">견적서 (Quotation)</span>
            </div>
        </div>

        <!-- 회사 정보 -->
        <div class="company-info-section" style="margin: 20px 0; background-color: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #2c5aa0;">
            <h3 style="color: #2c5aa0; margin: 0 0 15px 0; font-size: 16px; font-weight: bold;">📤 공급자 정보</h3>
            
            <!-- 회사명 -->
            <div style="text-align: center; margin-bottom: 20px;">
                <h4 style="color: #2c5aa0; margin: 0; font-size: 20px; font-weight: bold;">아이비에스 (<span style="color: #2c5aa0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); font-weight: 900;">I.B.S</span>)</h4>
            </div>
            
            <!-- 회사 정보와 대표자/직인 -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px; align-items: start;">
                <!-- 왼쪽: 회사 상세 정보 -->
                <div class="company-details">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px; line-height: 1.5;">
                        <div>
                            <p style="margin: 6px 0;"><strong>📍 주소:</strong> 수원시 장안구 율전동 417번길 52-5</p>
                            <p style="margin: 6px 0;"><strong>📞 전화:</strong> 010-3664-6268</p>
                            <p style="margin: 6px 0;"><strong>📠 팩스:</strong> 0504-440-6268</p>
                        </div>
                        <div>
                            <p style="margin: 6px 0;"><strong>📧 이메일:</strong> ibs@ibs-info.com</p>
                            <p style="margin: 6px 0;"><strong>🌐 홈페이지:</strong> web.ibs-info.com</p>
                            <p style="margin: 6px 0;"><strong>🏢 사업자등록번호:</strong> 405-08-53668</p>
                        </div>
                    </div>
                </div>
                
                <!-- 오른쪽: 대표자와 직인 -->
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <!-- 대표자 정보 -->
                    <div style="text-align: center;">
                        <p style="margin: 0 0 5px 0; font-size: 14px; font-weight: bold; color: #2c5aa0;">👤 대표자</p>
                        <p style="margin: 0; font-size: 16px; font-weight: bold; color: #333;">이준로</p>
                    </div>
                    
                    <!-- 직인 (고정 이미지) -->
                    <div class="company-seal" style="text-align: center;">
                        <img src="images/아이비에스직인.jpg" alt="회사 직인" style="width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; align-items: center; justify-content: center; width: 70px; height: 70px; border: 2px solid #ccc; border-radius: 50%; background-color: #f8f9fa; color: #666; font-size: 9px; text-align: center; line-height: 1.1;">
                            회사<br>직인
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="quote-form">
            <!-- 기본 정보 -->
            <div class="form-section">
                <h3>기본 정보</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>견적번호</label>
                        <input type="text" id="quoteNumber" value="IBS-2025-001">
                    </div>
                    <div class="form-group">
                        <label>견적일자</label>
                        <input type="date" id="quoteDate">
                    </div>
                    <div class="form-group">
                        <label>납품기한</label>
                        <select id="deliveryDays">
                            <option value="7">7일 이내</option>
                            <option value="10">10일 이내</option>
                            <option value="14">14일 이내</option>
                            <option value="21">21일 이내</option>
                            <option value="30">30일 이내</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>프로젝트명</label>
                        <input type="text" id="projectName" placeholder="프로젝트명을 입력하세요">
                    </div>
                </div>

            </div>

            <!-- 고객 정보 -->
            <div class="form-section">
                <h3>고객 정보</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>업체명</label>
                        <input type="text" id="clientCompany" placeholder="업체명">
                    </div>
                    <div class="form-group">
                        <label>담당자</label>
                        <input type="text" id="clientContact" placeholder="담당자명">
                    </div>
                    <div class="form-group">
                        <label>전화번호</label>
                        <input type="text" id="clientPhone" placeholder="전화번호">
                    </div>
                    <div class="form-group">
                        <label>이메일</label>
                        <input type="email" id="clientEmail" placeholder="이메일">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>주소</label>
                        <input type="text" id="clientAddress" placeholder="주소">
                    </div>
                    <div class="form-group">
                        <label>상태</label>
                        <select id="quoteStatus" onchange="autoSaveData()">
                            <option value="견적 발행">견적 발행</option>
                            <option value="견적 진행중">견적 진행중</option>
                            <option value="계약 성사">계약 성사</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>결제조건</label>
                        <select id="paymentTerms">
                            <option value="선입금">선입금</option>
                            <option value="착수금 50% + 완료 후 50%">착수금 50% + 완료 후 50%</option>
                            <option value="완료 후 지급">완료 후 지급</option>
                            <option value="협의">협의</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 견적 항목 테이블 -->
        <table class="quote-table" id="quoteTable">
            <thead>
                <tr>
                    <th style="width: 50px;">NO</th>
                    <th style="width: 140px;">서비스/제품명</th>
                    <th style="width: 300px;">규격/사양</th>
                    <th style="width: 60px;">수량</th>
                    <th style="width: 100px;">단가</th>
                    <th style="width: 100px;">금액</th>
                    <th style="width: 50px;">삭제</th>
                </tr>
            </thead>
            <tbody id="quoteItems">
                <tr>
                    <td>1</td>
                    <td>
                        <select onchange="updateSpecs(this)" class="editable">
                            <option value="">선택하세요</option>
                            <option value="Wire Probe JIG 설계">Wire Probe JIG 설계</option>
                            <option value="JIG 제작 서비스">JIG 제작 서비스</option>
                            <option value="MEMS JIG 개발">MEMS JIG 개발</option>
                            <option value="소프트웨어 교육">소프트웨어 교육</option>
                            <option value="기술 컨설팅">기술 컨설팅</option>
                            <option value="PCB 설계 서비스">PCB 설계 서비스</option>
                            <option value="테스트 픽스처 제작">테스트 픽스처 제작</option>
                            <option value="프로그래밍 서비스">프로그래밍 서비스</option>
                            <option value="직접입력">직접입력</option>
                        </select>
                    </td>
                    <td><textarea rows="3" class="editable"></textarea></td>
                    <td><input type="number" value="1" onchange="calculateAmount(this)" class="editable amount-input"></td>
                    <td><input type="text" value="0" onchange="formatPriceInput(this)" class="editable amount-input"></td>
                    <td><input type="text" value="0" readonly class="readonly amount-input"></td>
                    <td><button onclick="clearRow(this)" class="btn" style="background-color: #6c757d; font-size: 12px; padding: 5px 10px;">초기화</button></td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>
                        <select onchange="updateSpecs(this)" class="editable">
                            <option value="">선택하세요</option>
                            <option value="Wire Probe JIG 설계">Wire Probe JIG 설계</option>
                            <option value="JIG 제작 서비스">JIG 제작 서비스</option>
                            <option value="MEMS JIG 개발">MEMS JIG 개발</option>
                            <option value="소프트웨어 교육">소프트웨어 교육</option>
                            <option value="기술 컨설팅">기술 컨설팅</option>
                            <option value="PCB 설계 서비스">PCB 설계 서비스</option>
                            <option value="테스트 픽스처 제작">테스트 픽스처 제작</option>
                            <option value="프로그래밍 서비스">프로그래밍 서비스</option>
                            <option value="직접입력">직접입력</option>
                        </select>
                    </td>
                    <td><textarea rows="3" class="editable"></textarea></td>
                    <td><input type="number" value="1" onchange="calculateAmount(this)" class="editable amount-input"></td>
                    <td><input type="text" value="0" onchange="formatPriceInput(this)" class="editable amount-input"></td>
                    <td><input type="text" value="0" readonly class="readonly amount-input"></td>
                    <td><button onclick="clearRow(this)" class="btn" style="background-color: #6c757d; font-size: 12px; padding: 5px 10px;">초기화</button></td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>
                        <select onchange="updateSpecs(this)" class="editable">
                            <option value="">선택하세요</option>
                            <option value="Wire Probe JIG 설계">Wire Probe JIG 설계</option>
                            <option value="JIG 제작 서비스">JIG 제작 서비스</option>
                            <option value="MEMS JIG 개발">MEMS JIG 개발</option>
                            <option value="소프트웨어 교육">소프트웨어 교육</option>
                            <option value="기술 컨설팅">기술 컨설팅</option>
                            <option value="PCB 설계 서비스">PCB 설계 서비스</option>
                            <option value="테스트 픽스처 제작">테스트 픽스처 제작</option>
                            <option value="프로그래밍 서비스">프로그래밍 서비스</option>
                            <option value="직접입력">직접입력</option>
                        </select>
                    </td>
                    <td><textarea rows="3" class="editable"></textarea></td>
                    <td><input type="number" value="1" onchange="calculateAmount(this)" class="editable amount-input"></td>
                    <td><input type="text" value="0" onchange="formatPriceInput(this)" class="editable amount-input"></td>
                    <td><input type="text" value="0" readonly class="readonly amount-input"></td>
                    <td><button onclick="clearRow(this)" class="btn" style="background-color: #6c757d; font-size: 12px; padding: 5px 10px;">초기화</button></td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>
                        <select onchange="updateSpecs(this)" class="editable">
                            <option value="">선택하세요</option>
                            <option value="Wire Probe JIG 설계">Wire Probe JIG 설계</option>
                            <option value="JIG 제작 서비스">JIG 제작 서비스</option>
                            <option value="MEMS JIG 개발">MEMS JIG 개발</option>
                            <option value="소프트웨어 교육">소프트웨어 교육</option>
                            <option value="기술 컨설팅">기술 컨설팅</option>
                            <option value="PCB 설계 서비스">PCB 설계 서비스</option>
                            <option value="테스트 픽스처 제작">테스트 픽스처 제작</option>
                            <option value="프로그래밍 서비스">프로그래밍 서비스</option>
                            <option value="직접입력">직접입력</option>
                        </select>
                    </td>
                    <td><textarea rows="3" class="editable"></textarea></td>
                    <td><input type="number" value="1" onchange="calculateAmount(this)" class="editable amount-input"></td>
                    <td><input type="text" value="0" onchange="formatPriceInput(this)" class="editable amount-input"></td>
                    <td><input type="text" value="0" readonly class="readonly amount-input"></td>
                    <td><button onclick="clearRow(this)" class="btn" style="background-color: #6c757d; font-size: 12px; padding: 5px 10px;">초기화</button></td>
                </tr>
            </tbody>
        </table>

        <div class="btn-group">
            <button onclick="addRow()" class="btn">항목 추가</button>
            <button onclick="clearAll()" class="btn" style="background-color: #6c757d;">전체 초기화</button>
        </div>

        <!-- 할인/추가 서비스 -->
        <div class="form-section">
            <h3>할인 및 추가 서비스</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>할인 금액</label>
                    <input type="text" id="discountAmount" value="0" onchange="formatDiscountInput(this)" placeholder="할인 금액">
                </div>
                <div class="form-group">
                                            <label>추가 서비스</label>
                        <input type="text" id="additionalAmount" value="0" onchange="formatAdditionalInput(this)" placeholder="추가 서비스">
                </div>
            </div>
        </div>

        <!-- 합계 -->
        <div class="total-section">
            <div class="total-row">
                <span>소계:</span>
                <span id="subtotal">0원</span>
            </div>
            <div class="total-row">
                <span>할인:</span>
                <span id="discount">0원</span>
            </div>
            <div class="total-row">
                <span>추가 서비스:</span>
                <span id="additional">0원</span>
            </div>
            <div class="total-row">
                <span>견적금액:</span>
                <span id="totalBeforeVat">0원</span>
            </div>
            <div class="total-row">
                <span>부가세(10%):</span>
                <span id="vat">0원</span>
            </div>
            <div class="total-row final-total">
                <span>총 계약금액:</span>
                <span id="finalTotal">0원</span>
            </div>
        </div>

        <!-- 약정사항 추가 -->
        <div class="terms-section">
            <h4>※ 약정사항</h4>
            <ol>
                <li>공급자가 당사의 사전승인없이 본 견적서에 명기된 인도장소가 아닌 제3의 장소로 납품하는 경우 당사는 공급자에 대한 대금지급의무를 면한다.</li>
                <li>공급자가 정상적인 영업 또는 납품이 불가함이 명백한 경우 당사는 본 견적서를 해지할 수 있다.</li>
                <li>공급자는 본 견적상의 채권을 당사의 사전승인없이 제3자에게 양도할 수 없다.</li>
                <li>납품한 물품에 대한 당사 또는 당사고객의 검수요구 시 공급자는 이에 협조하여야 한다.</li>
                <li>기타 명시되지 않은 일반적인 사항은 별도 계약서나 일반적인 상관례에 따른다.</li>
            </ol>
        </div>

        <div class="btn-group">
                          <button onclick="sendEmail()" class="btn" style="background-color: #ea4335;">📧 메일 전송</button>
              <button onclick="downloadExcel()" class="btn">엑셀 다운로드</button>
              <button onclick="downloadPDF()" class="btn">📄 PDF 생성</button>
              <button onclick="downloadEnglishPDF()" class="btn" style="background-color: #17a2b8;">🌍 영문 PDF</button>
              <button onclick="saveToGoogleSheets()" class="btn" style="background-color: #0f9d58;">📊 구글시트 저장</button>
              <button onclick="sendToTransaction()" class="btn" style="background-color: #ff6b35;">📋 거래명세서로 전송</button>
              <button onclick="sendToInvoice()" class="btn" style="background-color: #6f42c1;">💰 인보이스 생성</button>
            <button onclick="openGoogleSheets()" class="btn" style="background-color: #4285f4;">📋 시트 열기</button>
            <button onclick="setupDropdowns()" class="btn" style="background-color: #28a745;">🎛️ 드롭다운 설정</button>
            <button onclick="fixDashboard()" class="btn" style="background-color: #ff6b35;">📊 고급 대시보드</button>
            <button onclick="createCharts()" class="btn" style="background-color: #9c27b0;">📈 차트 생성</button>
                          <button onclick="autoSaveData()" class="btn" style="background-color: #28a745;">데이터 보존</button>
              <button onclick="saveQuotationForDelivery()" class="btn" style="background-color: #17a2b8;">💾 견적서 저장</button>
        </div>
    </div>

    <script>
        // 스크롤 방지 함수
        function preventScroll() {
            // 입력 필드 포커스 시 스크롤 방지
            document.addEventListener('focusin', function(e) {
                if (e.target.matches('input, select, textarea')) {
                    // 현재 스크롤 위치 저장
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                    
                    // 포커스 후 스크롤 위치 복원
                    setTimeout(() => {
                        window.scrollTo(scrollLeft, scrollTop);
                    }, 0);
                }
            });
            
            // 입력 중 스크롤 방지
            document.addEventListener('input', function(e) {
                if (e.target.matches('input, select, textarea')) {
                    e.target.scrollIntoView = function() {}; // scrollIntoView 비활성화
                }
            });
        }
        
        // 오늘 날짜 설정 및 데이터 복원
        document.addEventListener('DOMContentLoaded', function() {
            // 스크롤 방지 기능 활성화
            preventScroll();
            
            document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];
            ensureFourRows(); // 항상 4개 항목 보장
            
            // 초기 할인/추가 금액 포맷팅 적용
            const discountInput = document.getElementById('discountAmount');
            const additionalInput = document.getElementById('additionalAmount');
            discountInput.value = formatNumber(parseNumber(discountInput.value));
            additionalInput.value = formatNumber(parseNumber(additionalInput.value));
            
            updateTotals();
            loadSavedData();
            
            // 견적서 직인 업로드 기능 설정
    
            

        });
        

        

        
        // 서비스별 기본 사양 데이터 (기존 + 추가 3개)
        const serviceSpecs = {
            'Wire Probe JIG 설계': {
                spec: '▶ 거버파일 분석 및 최적화 설계\n▶ 20년 경력 전문가 직접 설계\n▶ 3D 모델링 및 도면 제공\n▶ 설계 검증 및 시뮬레이션',
                price: 2000000
            },
            'JIG 제작 서비스': {
                spec: '▶ 설계 완료 후 완제품 제작\n▶ 품질 검증 및 테스트 완료\n▶ 1년 무상 A/S 포함\n▶ 현장 설치 및 교육',
                price: 3000000
            },
            'MEMS JIG 개발': {
                spec: '▶ 세계 최초 전기검사 MEMS JIG\n▶ 20~30㎛ 통합 Structure 설계\n▶ 고정밀 측정 솔루션\n▶ 완제품 제작 포함',
                price: 5000000
            },
            '소프트웨어 교육': {
                                        spec: '▶ IA-Station, EZ-Cat 교육\n▶ Cam350, AutoCAD 활용법\n▶ 1:1 맞춤 교육 (8시간)\n▶ 실습 자료 및 매뉴얼 제공',
                price: 500000
            },
            '기술 컨설팅': {
                spec: '▶ 20년 노하우 기반 기술 컨설팅\n▶ 설계 프로세스 최적화\n▶ 비용 절감 방안 제시\n▶ 정기 기술 지원',
                price: 1000000
            },
            'PCB 설계 서비스': {
                spec: '▶ 다층 PCB 설계 및 최적화\n▶ EMI/EMC 고려 설계\n▶ 부품 배치 최적화\n▶ 제조성 검토 포함',
                price: 1500000
            },
            '테스트 픽스처 제작': {
                spec: '▶ ICT/FCT 테스트 픽스처\n▶ 정밀 가공 및 조립\n▶ 성능 검증 완료\n▶ 유지보수 매뉴얼 제공',
                price: 2500000
            },
            '프로그래밍 서비스': {
                spec: '▶ 테스트 프로그램 개발\n▶ 자동화 시스템 구축\n▶ 디버깅 및 최적화\n▶ 기술 문서 작성',
                price: 800000
            }
        };

        function updateSpecs(selectElement) {
            // 규격/사양은 직접 입력하도록 변경 - 자동 생성 제거
            autoSaveData();
        }

        // 천단위 콤마 포맷팅 함수
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // 콤마 제거하여 숫자로 변환
        function parseNumber(str) {
            return parseFloat(str.toString().replace(/,/g, '')) || 0;
        }
        
        function calculateAmount(input) {
            const row = input.closest('tr');
            const quantity = parseNumber(row.cells[3].querySelector('input').value);
            const price = parseNumber(row.cells[4].querySelector('input').value);
            const amount = quantity * price;
            
            // 금액 필드에 천단위 콤마 적용
            row.cells[5].querySelector('input').value = formatNumber(amount);
            updateTotals();
            autoSaveData();
        }

        // 단가 입력 시 천단위 콤마 적용
        function formatPriceInput(input) {
            const value = parseNumber(input.value);
            input.value = formatNumber(value);
            calculateAmount(input);
        }
        
        // 할인 금액 입력 시 천단위 콤마 적용
        function formatDiscountInput(input) {
            const value = parseNumber(input.value);
            input.value = formatNumber(value);
            updateTotals();
        }
        
        // 추가 서비스 입력 시 천단위 콤마 적용
        function formatAdditionalInput(input) {
            const value = parseNumber(input.value);
            input.value = formatNumber(value);
            updateTotals();
        }
        
        function updateTotals() {
            const rows = document.querySelectorAll('#quoteItems tr');
            let subtotal = 0;
            
            rows.forEach(row => {
                const amount = parseNumber(row.cells[5].querySelector('input').value);
                subtotal += amount;
            });
            
            const discount = parseNumber(document.getElementById('discountAmount').value);
            const additional = parseNumber(document.getElementById('additionalAmount').value);
            const totalBeforeVat = subtotal - discount + additional;
            const vat = Math.round(totalBeforeVat * 0.1);
            const finalTotal = totalBeforeVat + vat;
            
            document.getElementById('subtotal').textContent = formatNumber(subtotal) + '원';
            document.getElementById('discount').textContent = formatNumber(discount) + '원';
            document.getElementById('additional').textContent = formatNumber(additional) + '원';
            document.getElementById('totalBeforeVat').textContent = formatNumber(totalBeforeVat) + '원';
            document.getElementById('vat').textContent = formatNumber(vat) + '원';
            document.getElementById('finalTotal').textContent = formatNumber(finalTotal) + '원';
        }

        function addRow() {
            const tbody = document.getElementById('quoteItems');
            const currentRows = tbody.children.length;
            
            // 최대 4개 항목까지만 허용
            if (currentRows >= 4) {
                alert('최대 4개 항목까지만 추가할 수 있습니다.');
                return;
            }
            
            const newRowNum = currentRows + 1;
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>${newRowNum}</td>
                <td>
                    <select onchange="updateSpecs(this)" class="editable">
                        <option value="">선택하세요</option>
                        <option value="Wire Probe JIG 설계">Wire Probe JIG 설계</option>
                        <option value="JIG 제작 서비스">JIG 제작 서비스</option>
                        <option value="MEMS JIG 개발">MEMS JIG 개발</option>
                        <option value="소프트웨어 교육">소프트웨어 교육</option>
                        <option value="기술 컨설팅">기술 컨설팅</option>
                        <option value="PCB 설계 서비스">PCB 설계 서비스</option>
                        <option value="테스트 픽스처 제작">테스트 픽스처 제작</option>
                        <option value="프로그래밍 서비스">프로그래밍 서비스</option>
                        <option value="직접입력">직접입력</option>
                    </select>
                </td>
                                    <td><textarea rows="3" class="editable" onchange="autoSaveData()"></textarea></td>
                <td><input type="number" value="1" onchange="calculateAmount(this)" class="editable amount-input"></td>
                <td><input type="number" value="0" onchange="calculateAmount(this)" class="editable amount-input"></td>
                <td><input type="number" value="0" readonly class="readonly amount-input"></td>
                <td><button onclick="clearRow(this)" class="btn" style="background-color: #6c757d; font-size: 12px; padding: 5px 10px;">초기화</button></td>
            `;
            
            tbody.appendChild(newRow);
            autoSaveData();
        }

        function clearRow(button) {
            const row = button.closest('tr');
            
            // 행의 내용을 초기화 (삭제하지 않음)
            row.cells[1].querySelector('select').value = '';
            row.cells[2].querySelector('textarea').value = '';
            row.cells[3].querySelector('input').value = 1;
            row.cells[4].querySelector('input').value = 0;
            row.cells[5].querySelector('input').value = 0;
            
            updateTotals();
            autoSaveData();
        }

        function removeRow(button) {
            // 기존 함수 호환성을 위해 clearRow로 리다이렉트
            clearRow(button);
        }

        function updateRowNumbers() {
            const rows = document.querySelectorAll('#quoteItems tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }

        function clearAll() {
            if (confirm('모든 내용을 초기화하시겠습니까?')) {
                document.querySelectorAll('input, select, textarea').forEach(element => {
                    if (element.type === 'date') {
                        element.value = new Date().toISOString().split('T')[0];
                    } else if (element.type === 'number') {
                        element.value = 0;
                    } else {
                        element.value = '';
                    }
                });
                
                // 항상 4개 항목 유지
                ensureFourRows();
                
                // 할인/추가 금액 필드에 천단위 콤마 적용
                document.getElementById('discountAmount').value = formatNumber(0);
                document.getElementById('additionalAmount').value = formatNumber(0);
                
                updateTotals();
                localStorage.removeItem('ibsQuoteData');
                document.getElementById('dataNotice').style.display = 'none';
            }
        }

        // 항상 4개 항목을 유지하는 함수
        function ensureFourRows() {
            const tbody = document.getElementById('quoteItems');
            const currentRows = tbody.children.length;
            
            // 4개보다 많으면 제거
            while (tbody.children.length > 4) {
                tbody.removeChild(tbody.lastChild);
            }
            
            // 4개보다 적으면 추가
            while (tbody.children.length < 4) {
                const newRowNum = tbody.children.length + 1;
                const newRow = document.createElement('tr');
                
                newRow.innerHTML = `
                    <td>${newRowNum}</td>
                    <td>
                        <select onchange="updateSpecs(this)" class="editable">
                            <option value="">선택하세요</option>
                            <option value="Wire Probe JIG 설계">Wire Probe JIG 설계</option>
                            <option value="JIG 제작 서비스">JIG 제작 서비스</option>
                            <option value="MEMS JIG 개발">MEMS JIG 개발</option>
                            <option value="소프트웨어 교육">소프트웨어 교육</option>
                            <option value="기술 컨설팅">기술 컨설팅</option>
                            <option value="PCB 설계 서비스">PCB 설계 서비스</option>
                            <option value="테스트 픽스처 제작">테스트 픽스처 제작</option>
                            <option value="프로그래밍 서비스">프로그래밍 서비스</option>
                            <option value="직접입력">직접입력</option>
                        </select>
                    </td>
                    <td><textarea rows="3" class="editable" onchange="autoSaveData()"></textarea></td>
                    <td><input type="number" value="1" onchange="calculateAmount(this)" class="editable amount-input"></td>
                    <td><input type="text" value="0" onchange="formatPriceInput(this)" class="editable amount-input"></td>
                    <td><input type="text" value="0" readonly class="readonly amount-input"></td>
                    <td><button onclick="clearRow(this)" class="btn" style="background-color: #6c757d; font-size: 12px; padding: 5px 10px;">초기화</button></td>
                `;
                
                tbody.appendChild(newRow);
            }
        }

        function autoSaveData() {
            const formData = {
                quoteNumber: document.getElementById('quoteNumber').value,
                quoteDate: document.getElementById('quoteDate').value,
                deliveryDays: document.getElementById('deliveryDays').value,
                projectName: document.getElementById('projectName').value,
                paymentTerms: document.getElementById('paymentTerms').value,
                clientCompany: document.getElementById('clientCompany').value,
                clientContact: document.getElementById('clientContact').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientEmail: document.getElementById('clientEmail').value,
                clientAddress: document.getElementById('clientAddress').value,
                quoteStatus: document.getElementById('quoteStatus').value,
                discountAmount: document.getElementById('discountAmount').value,
                additionalAmount: document.getElementById('additionalAmount').value,
                items: [],
                timestamp: new Date().getTime()
            };
            
            const rows = document.querySelectorAll('#quoteItems tr');
            rows.forEach(row => {
                const service = row.cells[1].querySelector('select').value;
                const spec = row.cells[2].querySelector('textarea').value;
                const quantity = row.cells[3].querySelector('input').value;
                const price = row.cells[4].querySelector('input').value;
                const amount = row.cells[5].querySelector('input').value;
                
                formData.items.push({
                    service, spec, quantity, price, amount
                });
            });
            
            localStorage.setItem('ibsQuoteData', JSON.stringify(formData));
            
            const notice = document.getElementById('dataNotice');
            notice.style.display = 'block';
            setTimeout(() => {
                notice.style.display = 'none';
            }, 3000);
        }

        function loadSavedData() {
            const savedData = localStorage.getItem('ibsQuoteData');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                const oneHour = 60 * 60 * 1000;
                if (new Date().getTime() - data.timestamp < oneHour) {
                    document.getElementById('quoteNumber').value = data.quoteNumber || '';
                    document.getElementById('quoteDate').value = data.quoteDate || new Date().toISOString().split('T')[0];
                    document.getElementById('deliveryDays').value = data.deliveryDays || '7';
                    document.getElementById('projectName').value = data.projectName || '';
                    document.getElementById('paymentTerms').value = data.paymentTerms || '선입금';
                    document.getElementById('clientCompany').value = data.clientCompany || '';
                    document.getElementById('clientContact').value = data.clientContact || '';
                    document.getElementById('clientPhone').value = data.clientPhone || '';
                    document.getElementById('clientEmail').value = data.clientEmail || '';
                    document.getElementById('clientAddress').value = data.clientAddress || '';
                    document.getElementById('quoteStatus').value = data.quoteStatus || '견적 발행';
                    document.getElementById('discountAmount').value = formatNumber(parseNumber(data.discountAmount) || 0);
                    document.getElementById('additionalAmount').value = formatNumber(parseNumber(data.additionalAmount) || 0);
                    
                    // 항상 4개 항목 유지하면서 데이터 복원
                    ensureFourRows();
                    
                    if (data.items && data.items.length > 0) {
                        const tbody = document.getElementById('quoteItems');
                        const rows = tbody.querySelectorAll('tr');
                        
                        // 최대 4개 항목까지만 복원
                        data.items.slice(0, 4).forEach((item, index) => {
                            if (rows[index]) {
                                rows[index].cells[1].querySelector('select').value = item.service || '';
                                rows[index].cells[2].querySelector('textarea').value = item.spec || '';
                                rows[index].cells[3].querySelector('input').value = item.quantity || 1;
                                rows[index].cells[4].querySelector('input').value = item.price || 0;
                                rows[index].cells[5].querySelector('input').value = item.amount || 0;
                            }
                        });
                        
                        updateTotals();
                        document.getElementById('dataNotice').style.display = 'block';
                        document.getElementById('dataNotice').innerHTML = '💾 이전에 입력된 데이터가 복원되었습니다.';
                    }
                }
            }
        }



        // 실제 Excel 파일(.xlsx) 자동 생성 함수
        async function downloadExcel() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '엑셀 생성 중...';
            btn.disabled = true;
            
            try {
                // SheetJS 라이브러리 동적 로드
                if (typeof XLSX === 'undefined') {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
                }
                
                // 워크북 생성
                const wb = XLSX.utils.book_new();
                
                // 견적서 데이터 준비
                const data = [];
                
                // 제목
                data.push(['IBS 견적서 (개선버전)', '', '', '', '', '']);
                data.push(['아이비에스(I.B.S) - InnoBridge SOLUTION', '', '', '', '', '']);
                data.push(['', '', '', '', '', '']);
                
                // 기본 정보
                data.push(['견적번호:', document.getElementById('quoteNumber').value, '', '견적일자:', document.getElementById('quoteDate').value, '']);
                data.push(['프로젝트명:', document.getElementById('projectName').value, '', '납품기한:', document.getElementById('deliveryDays').selectedOptions[0].text, '']);
                data.push(['결제조건:', document.getElementById('paymentTerms').value, '', '상태:', document.getElementById('quoteStatus').value, '']);
                data.push(['', '', '', '', '', '']);
                
                // 고객/공급자 정보
                data.push(['고객정보', '', '', '공급자정보', '', '']);
                data.push(['업체명:', document.getElementById('clientCompany').value, '', '상호:', '아이비에스(I.B.S)', '']);
                data.push(['담당자:', document.getElementById('clientContact').value, '', '담당자:', '이준로 대표', '']);
                data.push(['전화번호:', document.getElementById('clientPhone').value, '', '전화번호:', '010-3664-6268', '']);
                data.push(['이메일:', document.getElementById('clientEmail').value, '', '이메일:', 'jr.lee@ibs-info.com', '']);
                data.push(['주소:', document.getElementById('clientAddress').value, '', '주소:', '경기도 수원시 장안구 덕영대로 417번길 52-5 나동 502호', '']);
                data.push(['', '', '', '사업자등록번호:', '405-08-53668', '']);
                data.push(['', '', '', '', '', '']);
                
                // 견적 항목 헤더
                data.push(['NO', '서비스/제품명', '규격/사양', '수량', '단가', '금액']);
                
                // 견적 항목들
                const quoteRows = document.querySelectorAll('#quoteItems tr');
                let itemCount = 0;
                quoteRows.forEach((row, index) => {
                    const service = row.cells[1].querySelector('select').value;
                    const spec = row.cells[2].querySelector('textarea').value;
                    const quantity = parseInt(row.cells[3].querySelector('input').value) || 0;
                    const price = parseInt(row.cells[4].querySelector('input').value) || 0;
                    const amount = parseInt(row.cells[5].querySelector('input').value) || 0;
                    
                    if (service) {
                        itemCount++;
                        data.push([itemCount, service, spec, quantity, price, amount]);
                    }
                });
                
                // 할인/추가 서비스
                const discount = parseInt(document.getElementById('discountAmount').value) || 0;
                const additional = parseInt(document.getElementById('additionalAmount').value) || 0;
                if (discount > 0) {
                    data.push(['', '할인 적용', '', '', '', -discount]);
                }
                if (additional > 0) {
                    data.push(['', '추가 서비스', '', '', '', additional]);
                }
                
                data.push(['', '', '', '', '', '']);
                
                // 합계
                const totalBeforeVat = parseInt(document.getElementById('totalBeforeVat').textContent.replace('원', '').replace(/,/g, '')) || 0;
                const vat = parseInt(document.getElementById('vat').textContent.replace('원', '').replace(/,/g, '')) || 0;
                const finalTotal = parseInt(document.getElementById('finalTotal').textContent.replace('원', '').replace(/,/g, '')) || 0;
                
                data.push(['', '', '', '', '견적금액:', totalBeforeVat]);
                data.push(['', '', '', '', '부가세(10%):', vat]);
                data.push(['', '', '', '', '총 계약금액:', finalTotal]);
                
                // 워크시트 생성
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // 컬럼 너비 설정
                ws['!cols'] = [
                    { wch: 8 },   // NO
                    { wch: 25 },  // 서비스/제품명
                    { wch: 40 },  // 규격/사양
                    { wch: 8 },   // 수량
                    { wch: 15 },  // 단가
                    { wch: 15 }   // 금액
                ];
                
                // 워크시트를 워크북에 추가
                XLSX.utils.book_append_sheet(wb, ws, '견적서');
                
                // Excel 파일 다운로드
                const quoteNumber = document.getElementById('quoteNumber').value;
                XLSX.writeFile(wb, `IBS_견적서_${quoteNumber}.xlsx`);
                
                btn.textContent = '엑셀 완료!';
                btn.style.backgroundColor = '#28a745';
                
                alert('✅ Excel 파일(.xlsx)이 자동으로 다운로드되었습니다!');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#17a2b8';
                    btn.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('Excel 생성 오류:', error);
                btn.textContent = '엑셀 실패';
                btn.style.backgroundColor = '#dc3545';
                
                alert('❌ Excel 생성에 실패했습니다.\nCSV 형태로 다운로드합니다.');
                
                // 실패 시 기존 CSV 다운로드 사용
                downloadCSVFallback();
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#17a2b8';
                    btn.disabled = false;
                }, 3000);
            }
        }
        
        // CSV 대체 다운로드 함수
        function downloadCSVFallback() {
            const rows = [];
            
            rows.push(['IBS 견적서 (개선버전)', '', '', '', '', '']);
            rows.push(['아이비에스(I.B.S) - InnoBridge SOLUTION', '', '', '', '', '']);
            rows.push(['', '', '', '', '', '']);
            
            rows.push(['견적번호:', document.getElementById('quoteNumber').value, '', '견적일자:', document.getElementById('quoteDate').value, '']);
            rows.push(['프로젝트명:', document.getElementById('projectName').value, '', '납품기한:', document.getElementById('deliveryDays').selectedOptions[0].text, '']);
            rows.push(['결제조건:', document.getElementById('paymentTerms').value, '', '', '', '']);
            rows.push(['', '', '', '', '', '']);
            
            rows.push(['고객정보', '', '', '공급자정보', '', '']);
            rows.push(['업체명:', document.getElementById('clientCompany').value, '', '상호:', '아이비에스(I.B.S)', '']);
            rows.push(['담당자:', document.getElementById('clientContact').value, '', '담당자:', '이준로 대표', '']);
            rows.push(['전화번호:', document.getElementById('clientPhone').value, '', '전화번호:', '010-3664-6268', '']);
            rows.push(['이메일:', document.getElementById('clientEmail').value, '', '이메일:', 'jr.lee@ibs-info.com', '']);
            rows.push(['주소:', document.getElementById('clientAddress').value, '', '주소:', '경기도 수원시 장안구 덕영대로 417번길 52-5 나동 502호', '']);
            rows.push(['', '', '', '사업자등록번호:', '405-08-53668', '']);
            rows.push(['', '', '', '', '', '']);
            
            rows.push(['NO', '서비스/제품명', '규격/사양', '수량', '단가', '금액']);
            
            const quoteRows = document.querySelectorAll('#quoteItems tr');
            quoteRows.forEach((row, index) => {
                const service = row.cells[1].querySelector('select').value;
                const spec = row.cells[2].querySelector('textarea').value;
                const quantity = row.cells[3].querySelector('input').value;
                const price = row.cells[4].querySelector('input').value;
                const amount = row.cells[5].querySelector('input').value;
                
                if (service) {
                    rows.push([index + 1, service, spec, quantity, price, amount]);
                }
            });
            
            const discount = document.getElementById('discountAmount').value;
            const additional = document.getElementById('additionalAmount').value;
            if (discount > 0) {
                rows.push(['', '할인 적용', '', '', '', '-' + discount]);
            }
            if (additional > 0) {
                rows.push(['', '추가 서비스', '', '', '', additional]);
            }
            
            rows.push(['', '', '', '', '', '']);
            
            rows.push(['', '', '', '', '견적금액:', document.getElementById('totalBeforeVat').textContent.replace('원', '')]);
            rows.push(['', '', '', '', '부가세(10%):', document.getElementById('vat').textContent.replace('원', '')]);
            rows.push(['', '', '', '', '총 계약금액:', document.getElementById('finalTotal').textContent.replace('원', '')]);
            
            const csvContent = rows.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `IBS_견적서_${document.getElementById('quoteNumber').value}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // PDF 생성 (프린트 방식)
        function downloadPDF() {
            // 버튼과 알림 숨기기
            const buttons = document.querySelectorAll('.btn-group');
            const notice = document.querySelector('.data-notice');
            buttons.forEach(btn => btn.style.display = 'none');
            if (notice) notice.style.display = 'none';
            
            // 프린트 창 열기
            setTimeout(() => {
                window.print();
                
                // 버튼과 알림 다시 표시
                setTimeout(() => {
                    buttons.forEach(btn => btn.style.display = 'block');
                    if (notice) notice.style.display = 'block';
                }, 1000);
            }, 500);
        }
        

        
        // Gmail 메일 전송
        function sendEmail() {
            try {
                // 필수 정보 확인
                const clientEmail = document.getElementById('clientEmail').value;
                const clientCompany = document.getElementById('clientCompany').value;
                const clientContact = document.getElementById('clientContact').value;
                const quoteNumber = document.getElementById('quoteNumber').value;
                
                if (!clientEmail) {
                    throw new Error('고객 이메일을 입력해주세요.');
                }
                if (!clientCompany) {
                    throw new Error('고객 업체명을 입력해주세요.');
                }
                
                // 메일 내용 작성
                const finalTotal = document.getElementById('finalTotal').textContent;
                const projectName = document.getElementById('projectName').value || '프로젝트';
                
                const subject = `[I.B.S] ${projectName} 견적서 (${quoteNumber})`;
                
                const body = `안녕하세요, ${clientContact || '담당자'}님.

아이비에스(InnoBridge SOLUTION)입니다.

요청해주신 ${projectName}에 대한 견적서를 첨부파일로 보내드립니다.

📋 견적 요약:
• 견적번호: ${quoteNumber}
• 프로젝트: ${projectName}
• 총 계약금액: ${finalTotal}

첨부된 견적서를 검토해보시고, 궁금한 사항이나 추가 문의사항이 있으시면 언제든지 연락 주시기 바랍니다.

📧 회신은 대표메일(ibs@ibs-info.com)로 보내주시면 빠른 답변 드리겠습니다.

감사합니다.

---
아이비에스(I.B.S) - INNOVATION BRIDGE SOLUTION
담당자: 이준로 대표
전화: 010-3664-6268
팩스: 0504-440-6268
홈페이지: web.ibs-info.com
이메일: ibs@ibs-info.com (회신용 대표메일)
주소: 경기도 수원시 장안구 덕영대로 417번길 52-5 나동 502호
사업자등록번호: 405-08-53668`;
                
                // Gmail 작성 URL 생성
                const fromEmail = 'jr.lee@ibs-info.com';
                const gmailUrl = `https://mail.google.com/mail/u/${fromEmail}/?view=cm&fs=1&from=${encodeURIComponent(fromEmail)}&to=${encodeURIComponent(clientEmail)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // 안내 메시지
                alert(`📧 Gmail이 열립니다!\n\n📋 진행 순서:\n1. PDF 생성 버튼을 먼저 클릭하여 견적서 PDF를 저장하세요\n2. Gmail에서 PDF 파일을 첨부하세요\n3. 전송 버튼을 누르세요\n\n✅ 받는 사람: ${clientEmail}`);
                
                // Gmail 열기
                window.open(gmailUrl, '_blank');
                
            } catch (error) {
                alert(`❌ ${error.message}`);
            }
        }

        // 프린트 기반 PDF 생성 (대안)
        function downloadPDFPrint() {
            // 버튼과 알림 숨기기
            const buttons = document.querySelectorAll('.btn-group, .quote-table button, .company-seal button');
            const notice = document.querySelector('.data-notice');
            buttons.forEach(button => button.style.display = 'none');
            if (notice) notice.style.display = 'none';
            
            // 프린트 스타일 적용
            const printStyle = document.createElement('style');
            printStyle.id = 'print-style';
            printStyle.textContent = `
                @media print {
                    body * { visibility: hidden; }
                    .container, .container * { visibility: visible; }
                    .container { 
                        position: absolute; 
                        left: 0; 
                        top: 0; 
                        width: 100% !important;
                        margin: 0 !important;
                        padding: 0 !important;
                    }
                    .btn-group, .quote-table button, .company-seal button, .data-notice { 
                        display: none !important; 
                    }
                }
            `;
            document.head.appendChild(printStyle);
            
            // 프린트 실행
            setTimeout(() => {
                window.print();
                
                // 정리
                setTimeout(() => {
                    document.head.removeChild(printStyle);
                    buttons.forEach(button => button.style.display = '');
                    if (notice) notice.style.display = '';
                }, 1000);
            }, 500);
        }




        // 견적서를 거래명세서에서 불러올 수 있도록 저장
        function saveQuotationForDelivery() {
            try {
                // 견적서 데이터 수집
                const quotationData = {
                    quoteNumber: document.getElementById('quoteNumber').value || 'IBS-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-3),
                    projectName: document.getElementById('projectName').value || '프로젝트',
                    clientCompany: document.getElementById('clientCompany').value || '고객사',
                    clientContact: document.getElementById('clientContact').value || '담당자',
                    quoteDate: document.getElementById('quoteDate').value,
                    validUntil: document.getElementById('validUntil').value,
                    
                    // 품목 데이터 수집
                    items: [],
                    
                    // 금액 정보
                    subtotal: 0,
                    discountAmount: 0,
                    finalAmount: 0,
                    vatAmount: 0,
                    totalAmount: 0,
                    
                    // 메타데이터
                    type: 'quotation',
                    createdDate: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                // 테이블에서 품목 데이터 추출
                const rows = document.querySelectorAll('.quote-table tbody tr');
                let subtotal = 0;
                
                rows.forEach((row, index) => {
                    const serviceSelect = row.querySelector('select');
                    const specTextarea = row.querySelector('textarea');
                    const quantityInput = row.querySelector('input[type="number"]');
                    const priceInput = row.querySelectorAll('input')[1]; // 두 번째 input이 단가
                    const amountInput = row.querySelectorAll('input')[2]; // 세 번째 input이 금액
                    
                    if (serviceSelect && serviceSelect.value && specTextarea) {
                        const quantity = parseInt(quantityInput.value) || 1;
                        const unitPrice = parseNumber(priceInput.value) || 0;
                        const amount = parseNumber(amountInput.value) || (quantity * unitPrice);
                        
                        quotationData.items.push({
                            no: index + 1,
                            serviceName: serviceSelect.value,
                            specification: specTextarea.value,
                            quantity: quantity,
                            unitPrice: unitPrice,
                            amount: amount
                        });
                        
                        subtotal += amount;
                    }
                });
                
                // 금액 계산
                const discountAmount = parseNumber(document.getElementById('discountAmount').value) || 0;
                const additionalAmount = parseNumber(document.getElementById('additionalAmount').value) || 0;
                const finalAmount = subtotal - discountAmount + additionalAmount;
                const vatAmount = Math.floor(finalAmount * 0.1);
                const totalAmount = finalAmount + vatAmount;
                
                quotationData.subtotal = subtotal;
                quotationData.discountAmount = discountAmount;
                quotationData.finalAmount = finalAmount;
                quotationData.vatAmount = vatAmount;
                quotationData.totalAmount = totalAmount;
                
                // 로컬스토리지에 저장
                const key = `quotation_${quotationData.quoteNumber}_${Date.now()}`;
                localStorage.setItem(key, JSON.stringify(quotationData));
                
                alert(`✅ 견적서가 저장되었습니다!\n\n견적번호: ${quotationData.quoteNumber}\n고객사: ${quotationData.clientCompany}\n총금액: ${formatNumber(quotationData.totalAmount)}원\n\n※ 이제 거래명세서에서 이 견적서를 불러올 수 있습니다.`);
                console.log('💾 견적서 저장 완료:', quotationData);
                
            } catch (error) {
                console.error('❌ 견적서 저장 오류:', error);
                alert('견적서 저장 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 구글시트 저장 기능 (중복 실행 방지 강화)
        function saveToGoogleSheets() {
            // 중복 실행 방지
            if (window.isSaving) {
                console.log('⚠️ 이미 저장 중입니다');
                alert('이미 저장 중입니다. 잠시만 기다려주세요.');
                return;
            }
            window.isSaving = true;
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '저장 중...';
            btn.disabled = true;
            
            try {
                // 견적서 데이터 수집 (실제 시트 구조에 맞춤)
                const quotationData = {
                    quoteNumber: document.getElementById('quoteNumber').value,
                    quoteDate: document.getElementById('quoteDate').value,
                    projectName: document.getElementById('projectName').value,
                    deliveryDays: document.getElementById('deliveryDays').value,
                    paymentTerms: document.getElementById('paymentTerms').value,
                    clientCompany: document.getElementById('clientCompany').value,
                    clientContact: document.getElementById('clientContact').value,
                    clientPhone: document.getElementById('clientPhone').value,
                    clientEmail: document.getElementById('clientEmail').value,
                    clientAddress: document.getElementById('clientAddress').value,
                    quoteStatus: document.getElementById('quoteStatus').value,
                    discountAmount: parseNumber(document.getElementById('discountAmount').value) || 0,
                    additionalAmount: parseNumber(document.getElementById('additionalAmount').value) || 0,
                    subtotal: parseNumber(document.getElementById('totalBeforeVat').textContent.replace('원', '').replace(/,/g, '')) || 0,
                    vat: parseNumber(document.getElementById('vat').textContent.replace('원', '').replace(/,/g, '')) || 0,
                    finalTotal: parseNumber(document.getElementById('finalTotal').textContent.replace('원', '').replace(/,/g, '')) || 0,
                    items: []
                };
                
                // 견적 항목들 수집 (숫자 변환 적용)
                const rows = document.querySelectorAll('#quoteItems tr');
                rows.forEach(row => {
                    const service = row.cells[1].querySelector('select').value;
                    const spec = row.cells[2].querySelector('textarea').value;
                    const quantity = parseNumber(row.cells[3].querySelector('input').value) || 0;
                    const price = parseNumber(row.cells[4].querySelector('input').value) || 0;
                    const amount = parseNumber(row.cells[5].querySelector('input').value) || 0;
                    
                    if (service || spec || quantity > 0 || price > 0) { // 빈 항목이 아닌 경우만 추가
                        quotationData.items.push({
                            service: service,
                            spec: spec,
                            quantity: quantity,
                            price: price,
                            amount: amount
                        });
                    }
                });
                
                // 필수 데이터 검증
                if (!quotationData.quoteNumber) {
                    throw new Error('견적번호를 입력해주세요.');
                }
                if (!quotationData.clientCompany) {
                    throw new Error('고객 업체명을 입력해주세요.');
                }
                
                // Google Apps Script 웹앱 URL (새로 배포된 버전)
                const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw-8f6dWXixqUpfbHDbP4zS6kBEzitkqk4e148rvWxFQpeINaA8XAvrOY_nUb7Kra2jCA/exec';
                
                // 구글시트로 데이터 전송
                fetch(WEBAPP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(quotationData)
                })
                .then(response => {
                    // no-cors 모드에서는 response를 읽을 수 없으므로 성공으로 간주
                    window.isSaving = false; // 중복 실행 방지 flag 해제
                    btn.textContent = '저장 완료!';
                    btn.style.backgroundColor = '#28a745';
                    
                    alert(`✅ 견적서가 구글시트에 저장되었습니다!\n견적번호: ${quotationData.quoteNumber}\n\n구글시트에서 확인해보세요.`);
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.backgroundColor = '#0f9d58';
                        btn.disabled = false;
                    }, 3000);
                })
                .catch(error => {
                    console.error('구글시트 저장 오류:', error);
                    window.isSaving = false; // 중복 실행 방지 flag 해제
                    btn.textContent = '저장 실패';
                    btn.style.backgroundColor = '#dc3545';
                    
                    alert('❌ 구글시트 저장에 실패했습니다.\n\n다음을 확인해주세요:\n1. 인터넷 연결 상태\n2. Google Apps Script 웹앱 URL\n3. 권한 설정');
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.backgroundColor = '#0f9d58';
                        btn.disabled = false;
                    }, 3000);
                });
                
            } catch (error) {
                console.error('데이터 수집 오류:', error);
                window.isSaving = false; // 중복 실행 방지 flag 해제
                btn.textContent = '오류 발생';
                btn.style.backgroundColor = '#dc3545';
                
                alert(`❌ ${error.message}`);
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#0f9d58';
                    btn.disabled = false;
                }, 3000);
            }
        }
        
        // 구글시트 링크 열기 함수
        function openGoogleSheets() {
            const SPREADSHEET_ID = '1MUHiU8a0p1aBs0wU94gmmlugwmB9qSYO8NLl-qZ9-ho';
            const sheetUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}`;
            window.open(sheetUrl, '_blank');
        }

        // 🎛️ 드롭다운 설정 함수
        async function setupDropdowns() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '설정 중...';
            btn.disabled = true;
            
            try {
                const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw-8f6dWXixqUpfbHDbP4zS6kBEzitkqk4e148rvWxFQpeINaA8XAvrOY_nUb7Kra2jCA/exec';
                const setupUrl = WEBAPP_URL + '?action=setupQuotationValidation';
                
                const response = await fetch(setupUrl, {
                    method: 'GET'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    btn.textContent = '설정 완료!';
                    btn.style.backgroundColor = '#28a745';
                    
                    alert(`✅ 견적서 시트 드롭다운 설정 완료!\n\n📋 상태 드롭다운: ${result.data.statusDropdowns}개 행\n🎨 헤더 스타일링: 적용됨\n\n이제 상태 열에서 드롭다운으로 상태를 선택할 수 있습니다:\n• 견적 발행\n• 견적 진행중\n• 견적 수정\n• 계약 성사\n• 계약 실패\n• 보류`);
                } else {
                    btn.textContent = '설정 실패';
                    btn.style.backgroundColor = '#dc3545';
                    alert(`❌ 드롭다운 설정 실패: ${result.error}`);
                }
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#28a745';
                    btn.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('드롭다운 설정 오류:', error);
                btn.textContent = '설정 실패';
                btn.style.backgroundColor = '#dc3545';
                
                alert('❌ 드롭다운 설정 중 오류가 발생했습니다.');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#28a745';
                    btn.disabled = false;
                }, 3000);
            }
        }



        // 고급 대시보드 생성 함수
        async function fixDashboard() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '생성 중...';
            btn.disabled = true;
            
            try {
                const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyiJqdmcmKy7C10iGfcQtVjA3DdIEOROhOn9vzDhhQE1DGd8Ulh4a0mKgL6AcKopH0xxA/exec';
                const fixUrl = WEBAPP_URL + '?action=fixDashboard';
                
                await fetch(fixUrl, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                btn.textContent = '생성 완료!';
                btn.style.backgroundColor = '#28a745';
                
                alert('📊 고급 대시보드가 생성되었습니다!\n\n구글시트를 새로고침해서 확인해보세요.\n\n새로운 기능:\n📈 핵심 지표 (KPI)\n📊 상태별 현황 및 비율\n💰 금액 분석 (최소/최대/중간값)\n📅 최근 활동 (7일/오늘/어제)\n🎨 컬러풀한 섹션별 디자인');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#ff6b35';
                    btn.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('고급 대시보드 생성 오류:', error);
                btn.textContent = '생성 실패';
                btn.style.backgroundColor = '#dc3545';
                
                alert('❌ 고급 대시보드 생성 중 오류가 발생했습니다.\n다시 시도해주세요.');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#ff6b35';
                    btn.disabled = false;
                }, 3000);
            }
        }

        // 차트 생성 함수
        async function createCharts() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '차트 생성 중...';
            btn.disabled = true;
            
            try {
                const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyiJqdmcmKy7C10iGfcQtVjA3DdIEOROhOn9vzDhhQE1DGd8Ulh4a0mKgL6AcKopH0xxA/exec';
                const chartUrl = WEBAPP_URL + '?action=createCharts';
                
                await fetch(chartUrl, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                btn.textContent = '차트 완료!';
                btn.style.backgroundColor = '#28a745';
                
                alert('📈 고급 차트가 생성되었습니다!\n\n구글시트를 새로고침해서 확인해보세요.\n\n생성된 차트:\n📊 상태별 파이 차트 (견적발행/진행중/성사)\n📈 월별 트렌드 라인 차트 (최근 6개월)\n💰 금액 분포 막대 차트 (구간별 분석)\n\n시각적 분석으로 더 쉽게 현황을 파악하세요!');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#9c27b0';
                    btn.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('차트 생성 오류:', error);
                btn.textContent = '차트 실패';
                btn.style.backgroundColor = '#dc3545';
                
                alert('❌ 차트 생성 중 오류가 발생했습니다.\n다시 시도해주세요.');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#9c27b0';
                    btn.disabled = false;
                }, 3000);
            }
        }

        // 🔗 거래명세서로 데이터 전송 (통합 연동)
        function sendToTransaction() {
            try {
                // 안전한 요소 값 가져오기 함수
                function safeGetValue(id, defaultValue = '') {
                    const element = document.getElementById(id);
                    return element ? element.value : defaultValue;
                }
                
                // 견적서 데이터 수집
                const quotationData = {
                    quoteNumber: safeGetValue('quoteNumber') || 'IBS-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-3),
                    quoteDate: safeGetValue('quoteDate'),
                    projectName: safeGetValue('projectName') || '프로젝트',
                    clientCompany: safeGetValue('clientCompany') || '고객사',
                    clientContact: safeGetValue('clientContact') || '담당자',
                    clientPhone: safeGetValue('clientPhone'),
                    clientEmail: safeGetValue('clientEmail'),
                    clientAddress: safeGetValue('clientAddress'),
                    paymentTerms: safeGetValue('paymentTerms'),
                    deliveryDays: safeGetValue('deliveryDays'),
                    quoteStatus: safeGetValue('quoteStatus'),
                    validUntil: safeGetValue('validUntil'),
                    items: [],
                    subtotal: 0,
                    discountAmount: 0,
                    finalAmount: 0,
                    vatAmount: 0,
                    totalAmount: 0,
                    type: 'quotation',
                    createdDate: new Date().toISOString()
                };
                
                // 테이블에서 품목 데이터 추출
                const rows = document.querySelectorAll('.quote-table tbody tr');
                let subtotal = 0;
                
                rows.forEach((row, index) => {
                    const serviceSelect = row.querySelector('select');
                    const specTextarea = row.querySelector('textarea');
                    const quantityInput = row.querySelector('input[type="number"]');
                    const priceInputs = row.querySelectorAll('input[type="text"]');
                    
                    if (serviceSelect && serviceSelect.value && specTextarea) {
                        const quantity = parseInt((quantityInput && quantityInput.value) || '1') || 1;
                        const unitPrice = parseNumber((priceInputs[0] && priceInputs[0].value) || '0') || 0;
                        const amount = parseNumber((priceInputs[1] && priceInputs[1].value) || '0') || (quantity * unitPrice);
                        
                        quotationData.items.push({
                            no: index + 1,
                            serviceName: serviceSelect.value,
                            specification: specTextarea.value,
                            quantity: quantity,
                            unitPrice: unitPrice,
                            amount: amount
                        });
                        
                        subtotal += amount;
                    }
                });
                
                // 금액 계산
                const discountAmount = parseNumber(safeGetValue('discountAmount')) || 0;
                const additionalAmount = parseNumber(safeGetValue('additionalAmount')) || 0;
                const finalAmount = subtotal - discountAmount + additionalAmount;
                const vatAmount = Math.floor(finalAmount * 0.1);
                const totalAmount = finalAmount + vatAmount;
                
                quotationData.subtotal = subtotal;
                quotationData.discountAmount = discountAmount;
                quotationData.finalAmount = finalAmount;
                quotationData.vatAmount = vatAmount;
                quotationData.totalAmount = totalAmount;
                
                // 데이터 검증
                if (!quotationData.clientCompany || quotationData.clientCompany === '고객사') {
                    alert('❌ 고객 업체명을 입력해주세요.');
                    const clientCompanyEl = document.getElementById('clientCompany');
                    if (clientCompanyEl) clientCompanyEl.focus();
                    return;
                }
                
                if (quotationData.items.length === 0) {
                    alert('❌ 견적 항목을 입력해주세요.');
                    return;
                }
                
                // 로컬 스토리지에 저장 (거래명세서에서 읽을 수 있도록)
                const key = `quotation_${quotationData.quoteNumber}_${Date.now()}`;
                localStorage.setItem(key, JSON.stringify(quotationData));
                localStorage.setItem('lastQuotationKey', key); // 최근 견적서 키 저장
                
                // 거래명세서 페이지 열기
                const transactionUrl = './ibs_delivery_improved.html?from=quotation&key=' + encodeURIComponent(key);
                window.open(transactionUrl, '_blank');
                
                alert(`✅ 견적서가 거래명세서로 전송되었습니다!\n\n📋 견적번호: ${quotationData.quoteNumber}\n🏢 고객사: ${quotationData.clientCompany}\n📦 항목 수: ${quotationData.items.length}개\n💰 총금액: ${formatNumber(quotationData.totalAmount)}원\n\n새 창에서 거래명세서가 자동으로 채워집니다.`);
                
            } catch (error) {
                console.error('거래명세서 전송 오류:', error);
                alert('❌ 거래명세서 전송 중 오류가 발생했습니다.\n다시 시도해주세요.\n\n오류: ' + error.message);
            }
        }

        // 💰 견적서 데이터 수집 함수 (인보이스 전송용)
        function collectQuotationData() {
            // 안전한 요소 값 가져오기 함수
            function safeGetValue(id, defaultValue = '') {
                const element = document.getElementById(id);
                return element ? element.value : defaultValue;
            }
            
            // 안전한 텍스트 컨텐츠 가져오기 함수
            function safeGetTextContent(id, defaultValue = '0') {
                const element = document.getElementById(id);
                return element ? element.textContent.replace('원', '').replace(/,/g, '') : defaultValue;
            }
            
            const quotationData = {
                quoteNumber: safeGetValue('quoteNumber'),
                quoteDate: safeGetValue('quoteDate'),
                projectName: safeGetValue('projectName'),
                deliveryDays: safeGetValue('deliveryDays'),
                paymentTerms: safeGetValue('paymentTerms'),
                clientCompany: safeGetValue('clientCompany'),
                clientContact: safeGetValue('clientContact'),
                clientPhone: safeGetValue('clientPhone'),
                clientEmail: safeGetValue('clientEmail'),
                clientAddress: safeGetValue('clientAddress'),
                quoteStatus: safeGetValue('quoteStatus'),
                discountAmount: safeGetValue('discountAmount'),
                additionalAmount: safeGetValue('additionalAmount'),
                subtotal: safeGetTextContent('totalBeforeVat'),
                vat: safeGetTextContent('vat'),
                totalAmount: safeGetTextContent('finalTotal'),
                items: []
            };
            
            // 견적 항목들 수집
            const rows = document.querySelectorAll('#quoteItems tr');
            rows.forEach(row => {
                if (row.cells && row.cells.length >= 6) {
                    const selectEl = row.cells[1] ? row.cells[1].querySelector('select') : null;
                    const textareaEl = row.cells[2] ? row.cells[2].querySelector('textarea') : null;
                    const quantityEl = row.cells[3] ? row.cells[3].querySelector('input') : null;
                    const priceEl = row.cells[4] ? row.cells[4].querySelector('input') : null;
                    const amountEl = row.cells[5] ? row.cells[5].querySelector('input') : null;
                    
                    const service = selectEl ? selectEl.value : '';
                    const spec = textareaEl ? textareaEl.value : '';
                    const quantity = quantityEl ? quantityEl.value : '';
                    const price = priceEl ? priceEl.value : '';
                    const amount = amountEl ? amountEl.value : '';
                    
                    if (service || spec) { // 빈 항목이 아닌 경우만 추가
                        quotationData.items.push({
                            service: service,
                            spec: spec,
                            quantity: quantity,
                            price: price,
                            amount: amount
                        });
                    }
                }
            });
            
            return quotationData;
        }

        // 💰 인보이스로 데이터 전송 (새로운 함수)
        function sendToInvoice() {
            try {
                console.log('💰 인보이스 전송 시작');
                
                // 안전한 요소 값 가져오기 함수
                function safeGetValue(id, defaultValue = '') {
                    const element = document.getElementById(id);
                    return element ? element.value : defaultValue;
                }
                
                // 견적서 데이터 수집 (sendToTransaction과 동일한 방식)
                const quotationData = {
                    quoteNumber: safeGetValue('quoteNumber') || 'IBS-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-3),
                    quoteDate: safeGetValue('quoteDate'),
                    projectName: safeGetValue('projectName') || '프로젝트',
                    clientCompany: safeGetValue('clientCompany') || '고객사',
                    clientContact: safeGetValue('clientContact') || '담당자',
                    clientPhone: safeGetValue('clientPhone'),
                    clientEmail: safeGetValue('clientEmail'),
                    clientAddress: safeGetValue('clientAddress'),
                    paymentTerms: safeGetValue('paymentTerms'),
                    deliveryDays: safeGetValue('deliveryDays'),
                    quoteStatus: safeGetValue('quoteStatus'),
                    validUntil: safeGetValue('validUntil'),
                    items: [],
                    subtotal: 0,
                    discountAmount: 0,
                    finalAmount: 0,
                    vatAmount: 0,
                    totalAmount: 0,
                    type: 'quotation',
                    createdDate: new Date().toISOString()
                };
                
                // 테이블에서 품목 데이터 추출
                const rows = document.querySelectorAll('.quote-table tbody tr');
                let subtotal = 0;
                
                rows.forEach((row, index) => {
                    const serviceSelect = row.querySelector('select');
                    const specTextarea = row.querySelector('textarea');
                    const quantityInput = row.querySelector('input[type="number"]');
                    const priceInputs = row.querySelectorAll('input[type="text"]');
                    
                    if (serviceSelect && serviceSelect.value && specTextarea) {
                        const quantity = parseInt((quantityInput && quantityInput.value) || '1') || 1;
                        const unitPrice = parseNumber((priceInputs[0] && priceInputs[0].value) || '0') || 0;
                        const amount = parseNumber((priceInputs[1] && priceInputs[1].value) || '0') || (quantity * unitPrice);
                        
                        quotationData.items.push({
                            no: index + 1,
                            serviceName: serviceSelect.value,
                            specification: specTextarea.value,
                            quantity: quantity,
                            unitPrice: unitPrice,
                            amount: amount
                        });
                        
                        subtotal += amount;
                    }
                });
                
                // 금액 계산
                const discountAmount = parseNumber(safeGetValue('discountAmount')) || 0;
                const additionalAmount = parseNumber(safeGetValue('additionalAmount')) || 0;
                const finalAmount = subtotal - discountAmount + additionalAmount;
                const vatAmount = Math.floor(finalAmount * 0.1);
                const totalAmount = finalAmount + vatAmount;
                
                quotationData.subtotal = subtotal;
                quotationData.discountAmount = discountAmount;
                quotationData.finalAmount = finalAmount;
                quotationData.vatAmount = vatAmount;
                quotationData.totalAmount = totalAmount;
                
                // 데이터 검증
                if (!quotationData.clientCompany || quotationData.clientCompany === '고객사') {
                    alert('❌ 고객 업체명을 입력해주세요.');
                    const clientCompanyEl = document.getElementById('clientCompany');
                    if (clientCompanyEl) clientCompanyEl.focus();
                    return;
                }
                
                if (quotationData.items.length === 0) {
                    alert('❌ 견적 항목을 입력해주세요.');
                    return;
                }
                
                if (!confirm(`💰 이 견적서를 인보이스로 변환하시겠습니까?\n\n📋 견적번호: ${quotationData.quoteNumber}\n🏢 고객사: ${quotationData.clientCompany}\n📦 항목 수: ${quotationData.items.length}개\n💰 총금액: ${formatNumber(quotationData.totalAmount)}원\n\n인보이스가 자동으로 채워집니다.`)) {
                    return;
                }
                
                // 로컬 스토리지에 저장 (인보이스에서 읽을 수 있도록)
                const key = `quotation_${quotationData.quoteNumber}_${Date.now()}`;
                localStorage.setItem(key, JSON.stringify(quotationData));
                localStorage.setItem('lastQuotationKey', key); // 최근 견적서 키 저장
                
                // 인보이스 페이지 열기
                const invoiceUrl = './professional_invoice_a4_optimized.html?from=quotation&key=' + encodeURIComponent(key);
                window.open(invoiceUrl, '_blank');
                
                alert(`✅ 견적서가 인보이스로 전송되었습니다!\n\n📋 견적번호: ${quotationData.quoteNumber}\n🏢 고객사: ${quotationData.clientCompany}\n📦 항목 수: ${quotationData.items.length}개\n💰 총금액: ${formatNumber(quotationData.totalAmount)}원\n\n새 창에서 인보이스가 자동으로 채워집니다.`);
                
            } catch (error) {
                console.error('인보이스 전송 오류:', error);
                alert('❌ 인보이스 전송 중 오류가 발생했습니다.\n다시 시도해주세요.\n\n오류: ' + error.message);
            }
        }

        document.addEventListener('input', function(e) {
            if (e.target.matches('input, select, textarea')) {
                autoSaveData();
            }
        });

        // 영어 번역 데이터
        const englishTranslations = {
            // 헤더
            'I.B.S 견적서': 'I.B.S QUOTATION',
            '반도체 PCB 전기검사 JIG 솔루션': 'Semiconductor PCB Electrical Test JIG Solution',
            
            // 기본 정보
            '기본 정보': 'Basic Information',
            '견적번호': 'Quote Number',
            '견적일자': 'Quote Date',
            '유효기간': 'Valid Until',
            '프로젝트명': 'Project Name',
            
            // 고객 정보
            '고객 정보': 'Customer Information',
            '업체명': 'Company Name',
            '담당자': 'Contact Person',
            '전화번호': 'Phone Number',
            '이메일': 'Email',
            '주소': 'Address',
            
            // 결제 조건
            '결제 조건': 'Payment Terms',
            '결제조건': 'Payment Terms',
            '현금': 'Cash',
            '카드': 'Card',
            '계좌이체': 'Bank Transfer',
            '어음': 'Promissory Note',
            
            // 테이블 헤더
            'NO': 'NO',
            '서비스/제품명': 'Service/Product',
            '규격/사양': 'Specification',
            '수량': 'Quantity',
            '단가': 'Unit Price',
            '금액': 'Amount',
            '삭제': 'Delete',
            
            // 서비스명 (더 완전한 번역)
            '직접입력': 'Custom Input',
            'Wire Probe JIG 설계': 'Wire Probe JIG Design',
            'JIG 제작 서비스': 'JIG Manufacturing Service',
            'MEMS JIG 개발': 'MEMS JIG Development',
            '소프트웨어 교육': 'Software Training',
            '기술 컨설팅': 'Technical Consulting',
            'PCB 설계 서비스': 'PCB Design Service',
            '테스트 픽스처 제작': 'Test Fixture Manufacturing',
            '프로그래밍 서비스': 'Programming Service',
            
            // 할인 및 추가 서비스
            '할인 및 추가 서비스': 'Discount & Additional Services',
            '할인 금액': 'Discount Amount',
                            '추가 서비스': 'Additional Service',
            
            // 합계
            '소계': 'Subtotal',
            '할인': 'Discount',
            '추가 서비스': 'Additional Service',
            '견적금액': 'Quote Amount',
            '부가세(10%)': 'VAT (10%)',
            '총 계약금액': 'Total Contract Amount',
            
            // 약정사항
            '※ 약정사항': '※ Terms and Conditions',
            
            // 화폐 단위
            '원': 'KRW',
            
            // 버튼 텍스트
            '항목 추가': 'Add Item',
            '전체 초기화': 'Clear All',
            '초기화': 'Clear',
            
            // 플레이스홀더 텍스트
            '프로젝트명을 입력하세요': 'Enter project name',
            '업체명': 'Company name',
            '담당자명': 'Contact person',
            '전화번호': 'Phone number',
            '이메일': 'Email address',
            '주소를 입력하세요': 'Enter address',
            '할인 금액': 'Discount amount',
                            '추가 서비스': 'Additional service'
        };

        // 서비스 사양 영어 번역
        const englishServiceSpecs = {
            'Wire Probe JIG 설계': '▶ Gerber file analysis and optimization design\n▶ Direct design by 20-year experienced expert\n▶ 3D modeling and drawing provision\n▶ Design verification and simulation',
            'JIG 제작 서비스': '▶ Complete product manufacturing after design completion\n▶ Quality verification and testing completed\n▶ 1-year free A/S included\n▶ On-site installation and training',
            'MEMS JIG 개발': '▶ World\'s first electrical test MEMS JIG\n▶ 20~30㎛ integrated structure design\n▶ High-precision measurement solution\n▶ Complete product manufacturing included',
                                    '소프트웨어 교육': '▶ IA-Station, EZ-Cat training\n▶ Cam350, AutoCAD utilization\n▶ 1:1 customized training (8 hours)\n▶ Practice materials and manual provided',
            '기술 컨설팅': '▶ Technical consulting based on 20 years of know-how\n▶ Design process optimization\n▶ Cost reduction plan proposal\n▶ Regular technical support',
            'PCB 설계 서비스': '▶ High-quality PCB design and manufacturing\n▶ One-stop service from design to production\n▶ Design verification and optimization\n▶ Technical support and consultation',
            '테스트 픽스처 제작': '▶ Customized test fixture manufacturing\n▶ High-precision test support\n▶ Quality assurance and verification\n▶ Installation and operation training',
            '프로그래밍 서비스': '▶ Customized software development\n▶ Maintenance and support included\n▶ User training and documentation\n▶ Technical consultation and optimization'
        };

        // 영문 PDF 생성 함수 (완전 버전)
        function downloadEnglishPDF() {
            if (!confirm('🌍 영문 PDF를 생성하시겠습니까?\n\n프린트 대화상자에서 "PDF로 저장"을 선택해주세요.')) {
                return;
            }
            
            try {
                // 1. 헤더 번역
                const header = document.querySelector('.header h1');
                if (header) header.textContent = 'I.B.S QUOTATION';
                
                const headerSubtitle = document.querySelector('.header p');
                if (headerSubtitle) headerSubtitle.textContent = 'Semiconductor PCB Electrical Test JIG Solution';
                
                // 로고 대체 텍스트 번역
                const logoFallback = document.querySelector('.logo-fallback');
                if (logoFallback) {
                    logoFallback.innerHTML = 'InnoBridge<br>SOLUTION';
                }
                
                // 2. 섹션 제목 번역 (모든 섹션 포함)
                const sectionTitles = document.querySelectorAll('.form-section h3, h3');
                sectionTitles.forEach(title => {
                    if (title) {
                        const text = title.textContent.trim();
                        const sectionTranslations = {
                            '기본 정보': 'Basic Information',
                            '고객 정보': 'Customer Information', 
                            '결제 조건': 'Payment Terms',
                            '할인 및 추가 서비스': 'Discount & Additional Services',
                            '📤 공급자 정보': '📤 Supplier Information'
                        };
                        
                        if (sectionTranslations[text]) {
                            title.textContent = sectionTranslations[text];
                        }
                    }
                });
                
                // 3. 라벨 번역
                const labelTranslations = {
                    '견적번호': 'Quote Number',
                    '견적일자': 'Quote Date', 
                    '유효기간': 'Valid Until',
                    '납품기한': 'Delivery Period',
                    '프로젝트명': 'Project Name',
                    '업체명': 'Company Name',
                    '담당자': 'Contact Person',
                    '전화번호': 'Phone Number',
                    '이메일': 'Email',
                    '주소': 'Address',
                    '상태': 'Status',
                    '결제조건': 'Payment Terms',
                    '할인 금액': 'Discount Amount',
                    '추가 서비스': 'Additional Service'
                };
                
                const labels = document.querySelectorAll('label');
                labels.forEach(label => {
                    const text = label.textContent.trim();
                    if (labelTranslations[text]) {
                        label.textContent = labelTranslations[text];
                    }
                });
                
                // 공급자 정보 영역 번역
                const supplierTexts = document.querySelectorAll('.company-details p strong, .company-details p');
                supplierTexts.forEach(element => {
                    const text = element.textContent.trim();
                    const supplierTranslations = {
                        '📍 주소:': '📍 Address:',
                        '📞 전화:': '📞 Phone:',
                        '📠 팩스:': '📠 Fax:',
                        '📧 이메일:': '📧 Email:',
                        '🌐 홈페이지:': '🌐 Website:',
                        '🏢 사업자등록번호:': '🏢 Business Registration:',
                        '👤 대표자': '👤 CEO'
                    };
                    
                    if (supplierTranslations[text]) {
                        element.textContent = supplierTranslations[text];
                    }
                });
                
                // 직인 관련 텍스트 번역
                const sealTexts = document.querySelectorAll('.company-seal div, .company-seal button');
                sealTexts.forEach(element => {
                    if (element.textContent.includes('회사 직인')) {
                        element.innerHTML = 'Company<br>Seal<br>(Click)';
                    }
                    if (element.textContent.trim() === '기본') {
                        element.textContent = 'Default';
                    }
                });
                
                // 4. 테이블 헤더 번역
                const tableHeaders = document.querySelectorAll('.quote-table th');
                const headerTexts = ['NO', 'Service/Product', 'Specification', 'Quantity', 'Unit Price', 'Amount', 'Delete'];
                tableHeaders.forEach((th, index) => {
                    if (th && headerTexts[index]) {
                        th.textContent = headerTexts[index];
                    }
                });
                
                // 5. 모든 드롭다운 옵션 번역
                const allOptions = document.querySelectorAll('select option');
                const optionTranslations = {
                    // 기본 옵션
                    '선택하세요': 'Please Select',
                    '직접입력': 'Custom Input',
                    
                    // 서비스 옵션
                    'Wire Probe JIG 설계': 'Wire Probe JIG Design',
                    'JIG 제작 서비스': 'JIG Manufacturing Service',
                    'MEMS JIG 개발': 'MEMS JIG Development',
                    '소프트웨어 교육': 'Software Training',
                    '기술 컨설팅': 'Technical Consulting',
                    'PCB 설계 서비스': 'PCB Design Service',
                    '테스트 픽스처 제작': 'Test Fixture Manufacturing',
                    '프로그래밍 서비스': 'Programming Service',
                    
                    // 결제조건 옵션
                    '현금': 'Cash',
                    '카드': 'Card',
                    '계좌이체': 'Bank Transfer',
                    '어음': 'Promissory Note',
                    
                    // 유효기간/납품기한 옵션
                    '7일 이내': 'Within 7 days',
                    '10일 이내': 'Within 10 days',
                    '14일 이내': 'Within 14 days',
                    '15일 이내': 'Within 15 days',
                    '21일 이내': 'Within 21 days',
                    '30일 이내': 'Within 30 days',
                    '60일 이내': 'Within 60 days',
                    '90일 이내': 'Within 90 days',
                    
                    // 상태 옵션
                    '견적 발행': 'Quote Issued',
                    '견적 진행중': 'Quote In Progress',
                    '계약 성사': 'Contract Closed',
                    
                    // 결제조건 옵션
                    '선입금': 'Advance Payment',
                    '착수금 50% + 완료 후 50%': '50% Down + 50% Upon Completion',
                    '완료 후 지급': 'Payment After Completion',
                    '협의': 'Negotiable'
                };
                
                allOptions.forEach(option => {
                    const text = option.textContent.trim();
                    if (optionTranslations[text]) {
                        option.textContent = optionTranslations[text];
                    }
                });
                
                // 6. 서비스 사양 번역 (사용자 작성 내용 완전 보호)
                const specTextareas = document.querySelectorAll('.quote-table textarea');
                specTextareas.forEach(textarea => {
                    const row = textarea.closest('tr');
                    if (row) {
                        const serviceSelect = row.querySelector('select');
                        const currentValue = textarea.value.trim();
                        
                        // 내용이 있으면 사용자가 작성한 것으로 간주하고 절대 변경하지 않음
                        if (currentValue) {
                            // 시스템 디폴트 키워드 체크 (더 엄격하게)
                            const defaultKeywords = [
                                '▶ 거버파일 분석', '▶ 20년 경력', '▶ 3D 모델링',
                                '▶ 설계 완료', '▶ 품질 검증', '▶ 1년 무상',
                                '▶ 세계 최초', '▶ 20~30㎛', '▶ 고정밀 측정',
                                '▶ IA-Station', '▶ Cam350', '▶ 1:1 맞춤',
                                '▶ 20년 노하우', '▶ 설계 프로세스', '▶ 비용 절감'
                            ];
                            
                            const isSystemDefault = defaultKeywords.some(keyword => 
                                currentValue.includes(keyword)
                            );
                            
                            // 시스템 디폴트가 아니면 사용자 작성 내용으로 판단하고 보호
                            if (!isSystemDefault) {
                                console.log('사용자 작성 내용 보호:', currentValue);
                                return; // 변경하지 않음
                            }
                        }
                        
                        // 빈 칸이거나 확실한 시스템 디폴트인 경우만 영문으로 변경
                        if (serviceSelect && serviceSelect.value && 
                            serviceSelect.value !== '직접입력' && englishServiceSpecs[serviceSelect.value]) {
                            console.log('디폴트 사양 영문 변경:', serviceSelect.value);
                            textarea.value = englishServiceSpecs[serviceSelect.value];
                        }
                    }
                });
                
                // 7. 합계 섹션 번역
                const totalLabels = document.querySelectorAll('.total-row span:first-child');
                const totalTexts = ['Subtotal:', 'Discount:', 'Additional Service:', 'Quote Amount:', 'VAT (10%):', 'Total Contract Amount:'];
                totalLabels.forEach((label, index) => {
                    if (label && totalTexts[index]) {
                        label.textContent = totalTexts[index];
                    }
                });
                
                // 8. 금액 단위 변경
                const amountElements = document.querySelectorAll('#subtotal, #discount, #additional, #totalBeforeVat, #vat, #finalTotal');
                amountElements.forEach(element => {
                    if (element && element.textContent) {
                        element.textContent = element.textContent.replace(/원/g, 'KRW');
                    }
                });
                
                // 9. 약정사항 번역
                const termsTitle = document.querySelector('.terms-section h4');
                if (termsTitle) termsTitle.textContent = '※ Terms and Conditions';
                
                const termsItems = document.querySelectorAll('.terms-section ol li');
                const termsTexts = [
                    'If the supplier delivers to a third-party location other than the delivery location specified in this quotation without our prior approval, we shall be exempt from the obligation to pay the supplier.',
                    'If it is clear that the supplier cannot conduct normal business or delivery, we may terminate this quotation.',
                    'The supplier may not assign the claims under this quotation to a third party without our prior approval.',
                    'When we or our customers request inspection of delivered goods, the supplier must cooperate.',
                    'Other general matters not specified shall be governed by separate contracts or general commercial practices.'
                ];
                
                termsItems.forEach((item, index) => {
                    if (item && termsTexts[index]) {
                        item.textContent = termsTexts[index];
                    }
                });
                
                // 10. 버튼 텍스트 번역
                const addButton = document.querySelector('button[onclick="addRow()"]');
                if (addButton) addButton.textContent = 'Add Item';
                
                const clearButton = document.querySelector('button[onclick="clearAll()"]');
                if (clearButton) clearButton.textContent = 'Clear All';
                
                const clearRowButtons = document.querySelectorAll('button[onclick*="clearRow"]');
                clearRowButtons.forEach(btn => {
                    if (btn) btn.textContent = 'Clear';
                });
                
                // 기본 버튼 번역 (직인 관련)
                const defaultButtons = document.querySelectorAll('button');
                defaultButtons.forEach(btn => {
                    if (btn.textContent.trim() === '기본') {
                        btn.textContent = 'Default';
                    }
                });
                
                // 영문 PDF 전용 스타일 추가 (레이아웃 최적화)
                const englishStyle = document.createElement('style');
                englishStyle.id = 'english-pdf-style';
                englishStyle.textContent = `
                    @media print {
                        /* 전체 컨테이너 최적화 */
                        .container {
                            padding: 15px !important;
                            font-size: 10px !important;
                        }
                        
                        /* 헤더 최적화 */
                        .header {
                            padding: 15px 20px !important;
                            margin-bottom: 15px !important;
                            min-height: 60px !important;
                        }
                        
                        .header div:first-child {
                            gap: 15px !important;
                        }
                        
                        .header div:last-child {
                            font-size: 20px !important;
                            line-height: 1.1 !important;
                        }
                        
                        .header div:last-child span:first-child {
                            font-size: 24px !important;
                        }
                        
                        .header div:last-child span:last-child {
                            font-size: 14px !important;
                        }
                        
                        /* 로고 최적화 */
                        .header img {
                            height: 45px !important;
                            width: auto !important;
                            max-width: 150px !important;
                        }
                        
                        .logo-fallback {
                            width: 90px !important;
                            height: 45px !important;
                            font-size: 12px !important;
                            line-height: 1.1 !important;
                            font-weight: bold !important;
                        }
                        
                        /* 회사명 텍스트 최적화 */
                        .header div div:last-child {
                            font-size: 18px !important;
                            line-height: 1.1 !important;
                        }
                        
                        .header div div:last-child span {
                            font-size: 10px !important;
                        }
                        
                        /* 섹션 제목 최적화 */
                        .form-section {
                            padding: 6px 10px !important;
                            margin-bottom: 6px !important;
                        }
                        
                        .form-section h3 {
                            font-size: 13px !important;
                            margin: 0 0 4px 0 !important;
                            white-space: nowrap !important;
                        }
                        
                        /* 라벨 최적화 */
                        label {
                            font-size: 10px !important;
                            margin-bottom: 1px !important;
                            white-space: nowrap !important;
                            overflow: hidden !important;
                            text-overflow: ellipsis !important;
                        }
                        
                        /* 입력 필드 최적화 */
                        input, select, textarea {
                            font-size: 9px !important;
                            padding: 2px 3px !important;
                        }
                        
                        /* 테이블 최적화 */
                        .quote-table {
                            font-size: 8px !important;
                            margin: 8px 0 !important;
                        }
                        
                        .quote-table th {
                            font-size: 9px !important;
                            padding: 3px 1px !important;
                            white-space: nowrap !important;
                            line-height: 1.2 !important;
                        }
                        
                        .quote-table td {
                            font-size: 8px !important;
                            padding: 2px 1px !important;
                            line-height: 1.2 !important;
                        }
                        
                        .quote-table textarea {
                            font-size: 8px !important;
                            line-height: 1.2 !important;
                            padding: 2px !important;
                        }
                        
                        /* 합계 섹션 최적화 */
                        .total-section {
                            padding: 8px 10px !important;
                            margin-top: 8px !important;
                        }
                        
                        .total-row {
                            font-size: 10px !important;
                            margin-bottom: 2px !important;
                        }
                        
                        .total-row span:first-child {
                            white-space: nowrap !important;
                            font-size: 10px !important;
                        }
                        
                        .final-total {
                            font-size: 12px !important;
                            padding-top: 4px !important;
                        }
                        
                        /* 약정사항 최적화 */
                        .terms-section {
                            padding: 8px 10px !important;
                            margin-top: 10px !important;
                            font-size: 8px !important;
                        }
                        
                        .terms-section h4 {
                            font-size: 10px !important;
                            margin: 0 0 6px 0 !important;
                        }
                        
                        .terms-section ol {
                            line-height: 1.2 !important;
                            padding-left: 12px !important;
                        }
                        
                        .terms-section li {
                            margin-bottom: 2px !important;
                        }
                    }
                `;
                document.head.appendChild(englishStyle);
                
                // 버튼 숨기기
                const buttons = document.querySelectorAll('.btn-group');
                buttons.forEach(btn => btn.style.display = 'none');
                
                // 프린트 실행
                setTimeout(() => {
                    window.print();
                    
                    // 페이지 새로고침으로 복원 (스타일도 함께 제거됨)
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }, 500);
                
            } catch (error) {
                alert('❌ 영문 PDF 생성 중 오류가 발생했습니다: ' + error.message);
                location.reload();
            }
        }

                // 페이지를 영어로 번역하는 함수
        function translateToEnglish() {
            try {
                console.log('번역 함수 시작');
                
                // 1. 헤더 번역
                const header = document.querySelector('.header h1');
                if (header) {
                    header.textContent = 'I.B.S QUOTATION';
                    console.log('헤더 번역 완료');
                }
                
                const headerSubtitle = document.querySelector('.header p');
                if (headerSubtitle) {
                    headerSubtitle.textContent = 'Semiconductor PCB Electrical Test JIG Solution';
                }
                
                // 2. 섹션 제목 번역
                const sectionTitles = document.querySelectorAll('.form-section h3');
                const sectionTranslations = ['Basic Information', 'Customer Information', 'Payment Terms', 'Discount & Additional Services'];
                sectionTitles.forEach((title, index) => {
                    if (title && sectionTranslations[index]) {
                        title.textContent = sectionTranslations[index];
                    }
                });
                console.log('섹션 제목 번역 완료');
                
                // 3. 라벨 번역
                const labels = document.querySelectorAll('label');
                labels.forEach(label => {
                    try {
                        const text = label.textContent.trim();
                        if (text && englishTranslations[text]) {
                            label.textContent = englishTranslations[text];
                        }
                    } catch (e) {
                        console.log('라벨 번역 오류:', e);
                    }
                });
                console.log('라벨 번역 완료');
                
                // 4. 테이블 헤더 번역
                const tableHeaders = document.querySelectorAll('.quote-table th');
                const headerTranslations = ['NO', 'Service/Product', 'Specification', 'Quantity', 'Unit Price', 'Amount', 'Delete'];
                tableHeaders.forEach((header, index) => {
                    if (header && headerTranslations[index]) {
                        header.textContent = headerTranslations[index];
                    }
                });
                console.log('테이블 헤더 번역 완료');
                
                // 5. 서비스 옵션 번역
                const serviceSelects = document.querySelectorAll('select option');
                serviceSelects.forEach(option => {
                    try {
                        const text = option.textContent.trim();
                        if (text && englishTranslations[text]) {
                            option.textContent = englishTranslations[text];
                        }
                    } catch (e) {
                        console.log('서비스 옵션 번역 오류:', e);
                    }
                });
                console.log('서비스 옵션 번역 완료');
                
                // 6. 서비스 사양 번역
                const specTextareas = document.querySelectorAll('.quote-table textarea');
                specTextareas.forEach(textarea => {
                    try {
                        const row = textarea.closest('tr');
                        if (row) {
                            const serviceSelect = row.querySelector('select');
                            if (serviceSelect && serviceSelect.value && englishServiceSpecs[serviceSelect.value]) {
                                textarea.value = englishServiceSpecs[serviceSelect.value];
                            }
                        }
                    } catch (e) {
                        console.log('서비스 사양 번역 오류:', e);
                    }
                });
                console.log('서비스 사양 번역 완료');
                
                // 7. 합계 섹션 번역
                const totalLabels = document.querySelectorAll('.total-row span:first-child');
                const totalTranslations = ['Subtotal:', 'Discount:', 'Additional Service:', 'Quote Amount:', 'VAT (10%):', 'Total Contract Amount:'];
                totalLabels.forEach((label, index) => {
                    if (label && totalTranslations[index]) {
                        label.textContent = totalTranslations[index];
                    }
                });
                console.log('합계 섹션 번역 완료');
                
                // 8. 금액 단위 변경 (원 → KRW)
                const amountElements = document.querySelectorAll('#subtotal, #discount, #additional, #totalBeforeVat, #vat, #finalTotal');
                amountElements.forEach(element => {
                    if (element && element.textContent) {
                        element.textContent = element.textContent.replace(/원/g, 'KRW');
                    }
                });
                console.log('금액 단위 번역 완료');
                
                // 9. 약정사항 번역
                const termsTitle = document.querySelector('.terms-section h4');
                if (termsTitle) {
                    termsTitle.textContent = '※ Terms and Conditions';
                }
                
                const termsItems = document.querySelectorAll('.terms-section ol li');
                const termsTranslations = [
                    'If the supplier delivers to a third-party location other than the delivery location specified in this quotation without our prior approval, we shall be exempt from the obligation to pay the supplier.',
                    'If it is clear that the supplier cannot conduct normal business or delivery, we may terminate this quotation.',
                    'The supplier may not assign the claims under this quotation to a third party without our prior approval.',
                    'When we or our customers request inspection of delivered goods, the supplier must cooperate.',
                    'Other general matters not specified shall be governed by separate contracts or general commercial practices.'
                ];
                
                termsItems.forEach((item, index) => {
                    if (item && termsTranslations[index]) {
                        item.textContent = termsTranslations[index];
                    }
                });
                console.log('약정사항 번역 완료');
                
                // 10. 버튼 텍스트 번역 (프린트용)
                const addButton = document.querySelector('button[onclick="addRow()"]');
                if (addButton) addButton.textContent = 'Add Item';
                
                const clearButton = document.querySelector('button[onclick="clearAll()"]');
                if (clearButton) clearButton.textContent = 'Clear All';
                
                const clearRowButtons = document.querySelectorAll('button[onclick*="clearRow"]');
                clearRowButtons.forEach(btn => {
                    if (btn) btn.textContent = 'Clear';
                });
                console.log('버튼 텍스트 번역 완료');
                
                console.log('모든 번역 완료');
                
            } catch (error) {
                console.error('번역 함수 오류:', error);
                throw error;
            }
        }
    </script>
</body>
</html> 